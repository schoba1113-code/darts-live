<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Darts Rangliste</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="app">
<header>
  <h1>üéØ Darts Rangliste</h1>
</header>

<section class="card">
  <h2>Turnier erfassen</h2>
  <div class="form-row">
    <input id="tName" placeholder="Turniername">
    <input id="tDate" type="date">
  </div>
  <div id="gameInputs"></div>
  <button class="primary" id="addGameBtn">Spiel hinzuf√ºgen</button>
  <button class="primary" id="saveBtn">Turnier speichern</button>
  <button class="secondary" id="cancelBtn" style="display:none;">Abbrechen</button>
</section>

<section class="card">
  <h2>Zeitraum w√§hlen</h2>
  <select id="yearFilter"></select>
  <select id="monthFilter"></select>
  <button id="applyFilterBtn">Anwenden</button>
</section>

<section class="card">
  <h2>Gesamtrangliste</h2>
  <div id="ranking"></div>
</section>

<section class="card">
  <h2>Gespeicherte Turniere</h2>
  <div id="tournamentList"></div>
</section>

<section class="card">
  <h2>AVG Statistik (Balken)</h2>
  <canvas id="avgBarChart"></canvas>
</section>

<section class="card">
  <h2>AVG Trend</h2>
  <canvas id="avgTrendChart"></canvas>
</section>

<section class="card">
  <h2>DQ Statistik (Balken)</h2>
  <canvas id="dqBarChart"></canvas>
</section>

<section class="card">
  <h2>DQ Trend</h2>
  <canvas id="dqTrendChart"></canvas>
</section>

<section class="card">
  <h2>Siege</h2>
  <canvas id="winsChart"></canvas>
</section>

<section class="card">
  <h2>Differenz (GL-VL)</h2>
  <canvas id="diffChart"></canvas>
</section>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBpIYgzHZbrtjBAHrbVlsqwkuI6weoQD2o",
  authDomain: "darts-turniere-dacfc.firebaseapp.com",
  databaseURL: "https://darts-turniere-dacfc-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "darts-turniere-dacfc",
  storageBucket: "darts-turniere-dacfc.firebasestorage.app",
  messagingSenderId: "779378324704",
  appId: "1:779378324704:web:88aaf743660af6c138cc85"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const players = ["Pembe","Marki","Schoba"];
const gameInputs = document.getElementById("gameInputs");
const rankingDiv = document.getElementById("ranking");
const tournamentList = document.getElementById("tournamentList");
const yearFilter = document.getElementById("yearFilter");
const monthFilter = document.getElementById("monthFilter");
const saveBtn = document.getElementById("saveBtn");
const cancelBtn = document.getElementById("cancelBtn");
const addGameBtn = document.getElementById("addGameBtn");
const applyFilterBtn = document.getElementById("applyFilterBtn");

let allTournaments = {};
let currentGames = [];
let editId = null;
let avgBarChart, avgTrendChart, dqBarChart, dqTrendChart, winsChart, diffChart;

// Spiel hinzuf√ºgen UI
function renderGames() {
  gameInputs.innerHTML = "";
  currentGames.forEach((g, i) => {
    const div = document.createElement("div");
    div.className = "player-row";
    div.innerHTML = `
      <select class="player1">${players.map(p=>`<option value="${p}" ${p===g.player1?'selected':''}>${p}</option>`).join('')}</select>
      <select class="player2">${players.map(p=>`<option value="${p}" ${p===g.player2?'selected':''}>${p}</option>`).join('')}</select>
      <input placeholder="S" value="${g.s}" class="s">
      <input placeholder="N" value="${g.n}" class="n">
      <input placeholder="GL" value="${g.gl}" class="gl">
      <input placeholder="VL" value="${g.vl}" class="vl">
      <input placeholder="AVG" value="${g.avg}" class="avg">
      <input placeholder="DQ %" value="${g.dq}" class="dq">
      <button onclick="deleteGame(${i})">‚ùå</button>
    `;
    gameInputs.appendChild(div);

    // Inputs mit currentGames verbinden
    const updateGame = () => {
      const p1 = div.querySelector(".player1").value;
      const p2 = div.querySelector(".player2").value;
      const s = +div.querySelector(".s").value || 0;
      const n = +div.querySelector(".n").value || 0;
      const gl = +div.querySelector(".gl").value || 0;
      const vl = +div.querySelector(".vl").value || 0;
      const avg = +div.querySelector(".avg").value || 0;
      const dq = +div.querySelector(".dq").value || 0;
      currentGames[i] = {player1: p1, player2: p2, s, n, gl, vl, avg, dq};
    };
    div.querySelectorAll("input, select").forEach(inp => inp.addEventListener("input", updateGame));
  });
}

// Spiel l√∂schen
window.deleteGame = (index) => {
  if(!confirm("Spiel wirklich l√∂schen?")) return;
  currentGames.splice(index,1);
  renderGames();
};

// Neues Spiel hinzuf√ºgen
addGameBtn.addEventListener("click", () => {
  currentGames.push({player1:players[0], player2:players[1], s:0,n:0,gl:0,vl:0,avg:0,dq:0});
  renderGames();
});

// Turnier speichern
saveBtn.addEventListener("click", () => {
  if(!tName.value || !tDate.value){ alert("Name & Datum fehlen"); return; }
  const data = {name: tName.value, date: tDate.value, games: currentGames};

  if(editId){
    // Merge alte Spiele mit aktuellen, um Duplikate zu vermeiden
    const oldGames = allTournaments[editId]?.games || [];
    const mergedGames = [...oldGames, ...currentGames.slice(oldGames.length)];
    data.games = mergedGames;
    update(ref(db,"tournaments/"+editId),data);
    editId = null;
    saveBtn.textContent = "Turnier speichern";
    cancelBtn.style.display = "none";
  } else {
    push(ref(db,"tournaments"),data);
  }

  tName.value = "";
  tDate.value = "";
  currentGames = [];
  renderGames();
});

// Turnier abbrechen
cancelBtn.addEventListener("click", () => {
  editId = null;
  saveBtn.textContent = "Turnier speichern";
  cancelBtn.style.display = "none";
  tName.value = "";
  tDate.value = "";
  currentGames = [];
  renderGames();
});

// Turnier l√∂schen
window.deleteTournament = (id) => {
  if(!confirm("Turnier wirklich l√∂schen?")) return;
  remove(ref(db,"tournaments/"+id));
};

// Turnier bearbeiten
window.editTournament = (id) => {
  const tRef = ref(db,"tournaments/"+id);
  onValue(tRef, snap => {
    const t = snap.val();
    if(!t) return;
    tName.value = t.name;
    tDate.value = t.date;
    currentGames = t.games || [];
    renderGames();
    editId = id;
    saveBtn.textContent = "Update";
    cancelBtn.style.display = "inline-block";
  }, {onlyOnce:true});
};

// Live Listener
onValue(ref(db,"tournaments"), snap => {
  allTournaments = snap.val() || {};
  buildYearFilter();
  renderAll();
});

// Filter
function buildYearFilter() {
  const years = new Set();
  Object.values(allTournaments).forEach(t => years.add(t.date.slice(0,4)));
  yearFilter.innerHTML = '<option value="all">Alle Jahre</option>';
  [...years].sort().forEach(y => {
    yearFilter.innerHTML += `<option value="${y}">${y}</option>`;
  });
  buildMonthFilter();
}

function buildMonthFilter() {
  const selectedYear = yearFilter.value;
  const months = new Set();
  Object.values(allTournaments).forEach(t => {
    if(selectedYear === "all" || t.date.startsWith(selectedYear)) months.add(t.date.slice(5,7));
  });
  monthFilter.innerHTML = '<option value="all">Alle Monate</option>';
  [...months].sort().forEach(m => {
    const monthName = new Date(0, parseInt(m)-1).toLocaleString('de-DE',{month:'long'});
    monthFilter.innerHTML += `<option value="${m}">${monthName}</option>`;
  });
}

// Alle Turniere rendern
function renderAll() {
  const year = yearFilter.value;
  const month = monthFilter.value;
  const stats = {};
  const turnierLabels = [];
  players.forEach(p=>stats[p]={s:0,n:0,gl:0,vl:0,avg:[],dq:[],turniere:[]});

  tournamentList.innerHTML = "";
  Object.entries(allTournaments).forEach(([id,t]) => {
    if(year !== "all" && !t.date.startsWith(year)) return;
    if(month !== "all" && t.date.slice(5,7) !== month) return;

    const div = document.createElement("div");
    div.className = "tournament";
    div.innerHTML = `<span>${t.name} (${t.date})</span>
                     <button onclick="editTournament('${id}')">Bearbeiten</button>
                     <button onclick="deleteTournament('${id}')">L√∂schen</button>`;
    tournamentList.appendChild(div);

    // Stats berechnen
    t.games.forEach(g => {
      [g.player1, g.player2].forEach(p => {
        if(!stats[p]) stats[p]={s:0,n:0,gl:0,vl:0,avg:[],dq:[],turniere:[]};
      });
      stats[g.player1].s += g.s;
      stats[g.player1].n += g.n;
      stats[g.player1].gl += g.gl;
      stats[g.player1].vl += g.vl;
      stats[g.player1].avg.push(g.avg);
      stats[g.player1].dq.push(g.dq);

      stats[g.player2].s += g.s;
      stats[g.player2].n += g.n;
      stats[g.player2].gl += g.gl;
      stats[g.player2].vl += g.vl;
      stats[g.player2].avg.push(g.avg);
      stats[g.player2].dq.push(g.dq);
    });

    turnierLabels.push(t.name);
  });

  renderRanking(stats);
  renderCharts(stats, turnierLabels);
}

// Rangliste rendern
function renderRanking(stats){
  rankingDiv.innerHTML="";
  const sortable = players.map(p=>({...stats[p],player:p,diff:stats[p].gl-stats[p].vl}));
  sortable.sort((a,b)=>b.s-a.s||b.gl-a.gl||a.diff-b.diff);

  const highestAVG = Math.max(...players.map(p => stats[p].avg.reduce((sum,v)=>sum+v,0)/Math.max(stats[p].avg.length,1)));
  const bestDQ = Math.max(...players.map(p => stats[p].dq.reduce((sum,v)=>sum+v,0)/Math.max(stats[p].dq.length,1)));
  const mostWins = Math.max(...players.map(p => stats[p].s));

  sortable.forEach((r,i)=>{
    const medal = i<3?["ü•á","ü•à","ü•â"][i]:"";
    const badges = [];
    const avgMean = r.avg.reduce((sum,v)=>sum+v,0)/Math.max(r.avg.length,1);
    const dqMean = r.dq.reduce((sum,v)=>sum+v,0)/Math.max(r.dq.length,1);
    if(avgMean === highestAVG) badges.push("üåü");
    if(dqMean === bestDQ) badges.push("‚ö°");
    if(r.s === mostWins) badges.push("üèÜ");

    rankingDiv.innerHTML += `<div class="rank-row ${i===0?'gold':i===1?'silver':i===2?'bronze':''}">
      <span class="medal">${medal}</span> ${r.player} ${badges.join('')} | S:${r.s} N:${r.n} GL:${r.gl} VL:${r.vl} Diff:${r.diff}
    </div>`;
  });
}

// Charts rendern (wie vorher)
function renderCharts(stats, turnierLabels){
  const labels = turnierLabels.map((t,i)=>i+1);
  avgBarChart?.destroy();
  avgTrendChart?.destroy();
  dqBarChart?.destroy();
  dqTrendChart?.destroy();
  winsChart?.destroy();
  diffChart?.destroy();

  avgBarChart = new Chart(document.getElementById("avgBarChart"),{
    type:"bar",
    data:{labels,datasets: players.map((p,i)=>({label:p+" AVG",data:stats[p].avg,backgroundColor:["#f59e0b","#6b7280","#b87333"][i],borderRadius:5}))},
    options:{responsive:true,plugins:{legend:{position:'top'}},scales:{x:{title:{display:true,text:'Spiel'}},y:{title:{display:true,text:'AVG'}}}}
  });
  avgTrendChart = new Chart(document.getElementById("avgTrendChart"),{
    type:"line",
    data:{labels,datasets: players.map((p,i)=>({label:p+" AVG",data:stats[p].avg,borderColor:["#f59e0b","#6b7280","#b87333"][i],backgroundColor:["#f59e0b","#6b7280","#b87333"][i],tension:0.3,fill:false,pointRadius:5}))},
    options:{responsive:true,plugins:{legend:{position:'top'}},scales:{x:{title:{display:true,text:'Spiel'}},y:{title:{display:true,text:'AVG'}}}}
  });
  dqBarChart = new Chart(document.getElementById("dqBarChart"),{
    type:"bar",
    data:{labels,datasets: players.map((p,i)=>({label:p+" DQ %",data:stats[p].dq,backgroundColor:["#fde68a","#e5e7eb","#a97142"][i],borderRadius:5}))},
    options:{responsive:true,plugins:{legend:{position:'top'}},scales:{x:{title:{display:true,text:'Spiel'}},y:{title:{display:true,text:'DQ %'}}}}
  });
  dqTrendChart = new Chart(document.getElementById("dqTrendChart"),{
    type:"line",
    data:{labels,datasets: players.map((p,i)=>({label:p+" DQ %",data:stats[p].dq,borderColor:["#fde68a","#e5e7eb","#a97142"][i],backgroundColor:["#fde68a","#e5e7eb","#a97142"][i],tension:0.3,fill:false,pointRadius:5}))},
    options:{responsive:true,plugins:{legend:{position:'top'}},scales:{x:{title:{display:true,text:'Spiel'}},y:{title:{display:true,text:'DQ %'}}}}
  });
  winsChart = new Chart(document.getElementById("winsChart"),{
    type:"bar",
    data:{labels:players,datasets:[{label:"Siege",data:players.map(p=>stats[p].s),backgroundColor:["#fde68a","#e5e7eb","#a97142"],borderRadius:8}]},
    options:{responsive:true,plugins:{tooltip:{callbacks:{label:(ctx)=>`Siege: ${ctx.raw}`}},legend:{display:false}},scales:{y:{beginAtZero:true,title:{display:true,text:'Siege'}}}}
  });
  diffChart = new Chart(document.getElementById("diffChart"),{
    type:"bar",
    data:{labels:players,datasets:[{label:"Differenz (GL-VL)",data:players.map(p=>stats[p].gl-stats[p].vl),backgroundColor:["#fcd34d","#d1d5db","#b87333"],borderRadius:8}]},
    options:{responsive:true,plugins:{tooltip:{callbacks:{label:(ctx)=>`Diff: ${ctx.raw}`}},legend:{display:false}},scales:{y:{beginAtZero:true,title:{display:true,text:'Differenz'}}}}
  });
}

</script>
</body>
</html>
