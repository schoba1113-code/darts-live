<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Darts Rangliste</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="app">
<header>
  <h1>üéØ Darts Rangliste</h1>
</header>

<section class="card">
  <h2>Turnier erfassen</h2>
  <div class="form-row">
    <input id="tName" placeholder="Turniername">
    <input id="tDate" type="date" class="date-input" data-placeholder="tt.mm.jjj" aria-label="Datum">
  </div>
</section>


  <div id="gameForm">
    <h3>Spiel hinzuf√ºgen</h3>
    <div class="form-row">
      <select id="player1">
        <option value="">Spieler 1</option>
      </select>
      <select id="player2">
        <option value="">Spieler 2</option>
      </select>
    </div>
    <div class="player-row" id="gameStats">
<strong id="p1-label">Spieler 1</strong>
      <input placeholder="S" id="p1-s">
      <input placeholder="N" id="p1-n">
      <input placeholder="GL" id="p1-gl">
      <input placeholder="VL" id="p1-vl">
      <input placeholder="AVG" id="p1-avg">
      <input placeholder="DQ %" id="p1-dq">
    </div>
    <div class="player-row" id="gameStats2">
     <strong id="p2-label">Spieler 2</strong>
      <input placeholder="S" id="p2-s">
      <input placeholder="N" id="p2-n">
      <input placeholder="GL" id="p2-gl">
      <input placeholder="VL" id="p2-vl">
      <input placeholder="AVG" id="p2-avg">
      <input placeholder="DQ %" id="p2-dq">
    </div>
    <button class="primary" id="addGameBtn">Spiel hinzuf√ºgen</button>
    <ul id="gameList"></ul>
  </div>

  <button class="primary" id="saveBtn">Turnier speichern</button>
  <button class="secondary" id="cancelBtn" style="display:none;">Abbrechen</button>
</section>

<section class="card filter-card">
  <h2>Zeitraum w√§hlen</h2>

  <div class="filter-group">
    <label>Jahr</label>
    <select id="yearFilter"></select>
  </div>

  <div class="filter-group">
    <label>Monat</label>
    <select id="monthFilter"></select>
  </div>

  <div class="filter-group">
    <label>Woche</label>
    <select id="weekFilter">
      <option value="all">Alle Wochen</option>
    </select>
  </div>

  <div class="filter-group">
    <label>Tag</label>
    <input type="date" id="dayFilter">
    <button type="button" id="resetDayBtn" class="secondary-btn">
      Alle Tage
    </button>
  </div>

  <button id="applyFilterBtn" class="primary-btn">
    Anwenden
  </button>
</section>

<section class="card">
  <h2>Gesamtrangliste</h2>
  <div id="ranking"></div>
</section>

<section class="card">
  <h2 class="collapsible-header" onclick="toggleTournamentList()">
    Gespeicherte Turniere ‚¨áÔ∏è
  </h2>

  <div id="tournamentListWrapper" style="display:none;">
    <div id="tournamentList"></div>
  </div>
</section>

<section class="card">
  <h2>AVG Statistik (Balken)</h2>
  <canvas id="avgBarChart"></canvas>
</section>

<section class="card">
  <h2>AVG Trend</h2>
  <canvas id="avgTrendChart"></canvas>
</section>

<section class="card">
  <h2>DQ Statistik (Balken)</h2>
  <canvas id="dqBarChart"></canvas>
</section>

<section class="card">
  <h2>DQ Trend</h2>
  <canvas id="dqTrendChart"></canvas>
</section>

<section class="card">
  <h2>Siege</h2>
  <canvas id="winsChart"></canvas>
</section>

<section class="card">
  <h2>Differenz (GL-VL)</h2>
  <canvas id="diffChart"></canvas>
</section>

<!-- üéØ 180er erfassen ‚Äì HTML -->
<section class="card">
  <h2 class="collapsible-header" onclick="toggleHSList()">üéØ 180er erfassen ‚¨áÔ∏è</h2>
  <div id="hsWrapper" style="display:block; margin-top:10px;">
    <div class="form-row">
      <select id="hsPlayer"><option value="">Spieler ausw√§hlen</option></select>
      <input type="number" id="hsCount" placeholder="Anzahl 180er" min="1">
      <button id="addHSBtn" class="primary">Hinzuf√ºgen</button>
    </div>
    <table id="hsTable" border="1" style="width:100%; margin-top:10px; border-collapse: collapse;">
      <thead>
        <tr>
          <th>Spieler</th>
          <th>Gesamt 180er</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

</div> <!-- Ende app -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBpIYgzHZbrtjBAHrbVlsqwkuI6weoQD2o",
  authDomain: "darts-turniere-dacfc.firebaseapp.com",
  databaseURL: "https://darts-turniere-dacfc-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "darts-turniere-dacfc",
  storageBucket: "darts-turniere-dacfc.appspot.com",
  messagingSenderId: "779378324704",
  appId: "1:779378324704:web:88aaf743660af6c138cc85"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const players = ["Pembe","Marki","Schoba"];
const player1Select = document.getElementById("player1");
const player2Select = document.getElementById("player2");
const p1Label = document.getElementById("p1-label");
const p2Label = document.getElementById("p2-label");
  
const gameList = document.getElementById("gameList");
const saveBtn = document.getElementById("saveBtn");
const cancelBtn = document.getElementById("cancelBtn");
const applyFilterBtn = document.getElementById("applyFilterBtn");
const rankingDiv = document.getElementById("ranking");
const tournamentList = document.getElementById("tournamentList");
const yearFilter = document.getElementById("yearFilter");
const monthFilter = document.getElementById("monthFilter");
const dayFilter = document.getElementById("dayFilter");  // Tagesfeld
const resetDayBtn = document.getElementById("resetDayBtn"); // Button zum Zur√ºcksetzen

resetDayBtn.addEventListener("click", () => {
  dayFilter.value = "";  // setzt das Tagesfeld zur√ºck
  renderAll();           // zeigt wieder alle Turniere an
});
  
  
  
// const p1Label = document.getElementById("p1-label"); // bereits oben deklariert
// const p2Label = document.getElementById("p2-label"); // bereits oben deklariert


let allTournaments = {};
let games = [];
let editId = null;

// Charts
let avgBarChart, avgTrendChart, dqBarChart, dqTrendChart, winsChart, diffChart;

// Spieler f√ºr Dropdown
players.forEach(p=>{
  player1Select.innerHTML += `<option value="${p}">${p}</option>`;
  player2Select.innerHTML += `<option value="${p}">${p}</option>`;
});

document.getElementById("addGameBtn").addEventListener("click", addGame);
saveBtn.addEventListener("click", saveTournament);
cancelBtn.addEventListener("click", cancelEdit);
applyFilterBtn.addEventListener("click", renderAll);

player1Select.addEventListener("change", () => {
  p1Label.textContent = player1Select.value || "Spieler 1";
});

player2Select.addEventListener("change", () => {
  p2Label.textContent = player2Select.value || "Spieler 2";
});
  
// Spiel hinzuf√ºgen
function addGame(){
  const p1 = player1Select.value;
  const p2 = player2Select.value;
  if(!p1 || !p2 || p1===p2){ alert("Bitte zwei verschiedene Spieler w√§hlen"); return; }

  const gameData = {
    [p1]:{
      s:+document.getElementById("p1-s").value||0,
      n:+document.getElementById("p1-n").value||0,
      gl:+document.getElementById("p1-gl").value||0,
      vl:+document.getElementById("p1-vl").value||0,
      avg:+document.getElementById("p1-avg").value||0,
      dq:+document.getElementById("p1-dq").value||0
    },
    [p2]:{
      s:+document.getElementById("p2-s").value||0,
      n:+document.getElementById("p2-n").value||0,
      gl:+document.getElementById("p2-gl").value||0,
      vl:+document.getElementById("p2-vl").value||0,
      avg:+document.getElementById("p2-avg").value||0,
      dq:+document.getElementById("p2-dq").value||0
    }
  };

  games.push(gameData);

   // Liste aktualisieren
  renderGameList(); // <--- hier aufrufen

  // Inputs zur√ºcksetzen
  ["p1","p2"].forEach(p=>{
    ["s","n","gl","vl","avg","dq"].forEach(f=>document.getElementById(`${p}-${f}`).value="");
  });
  p1Label.textContent = "Spieler 1";
p2Label.textContent = "Spieler 2";
player1Select.value = "";
player2Select.value = "";
}
function renderGameList(){
  gameList.innerHTML = "";
  games.forEach((g, idx) => {
    const playersInGame = Object.keys(g);
    const li = document.createElement("li");
    li.innerHTML = `
      ${playersInGame[0]} vs ${playersInGame[1]} | 
      S: ${g[playersInGame[0]].s}-${g[playersInGame[1]].s}, 
      N: ${g[playersInGame[0]].n}-${g[playersInGame[1]].n}, 
      GL: ${g[playersInGame[0]].gl}-${g[playersInGame[1]].gl}, 
      VL: ${g[playersInGame[0]].vl}-${g[playersInGame[1]].vl}
      <button onclick="editGame(${idx})">Bearbeiten</button>
      <button onclick="deleteGame(${idx})">L√∂schen</button>
    `;
    gameList.appendChild(li);
  });
}

// Spiel bearbeiten
window.editGame = function(idx){
  const game = games[idx];
  const playersInGame = Object.keys(game);

  // Inputs mit den Werten f√ºllen
  ["p1","p2"].forEach((p,i)=>{
    const player = playersInGame[i];
    document.getElementById(`${p}-s`).value = game[player].s;
    document.getElementById(`${p}-n`).value = game[player].n;
    document.getElementById(`${p}-gl`).value = game[player].gl;
    document.getElementById(`${p}-vl`).value = game[player].vl;
    document.getElementById(`${p}-avg`).value = game[player].avg;
    document.getElementById(`${p}-dq`).value = game[player].dq;
  });

  // Spieler-Labels & Selects anpassen
  p1Label.textContent = playersInGame[0];
  p2Label.textContent = playersInGame[1];
  player1Select.value = playersInGame[0];
  player2Select.value = playersInGame[1];

  // Spiel tempor√§r entfernen, bis es wieder gespeichert wird
  games.splice(idx,1);
  renderGameList();
}

// Spiel l√∂schen
window.deleteGame = function(idx){
  if(confirm("Dieses Spiel wirklich l√∂schen?")){
    games.splice(idx,1);
    renderGameList();
  }
}
  
// Turnier speichern
function saveTournament(){
  if(!document.getElementById("tName").value || !document.getElementById("tDate").value){ 
    alert("Name & Datum fehlen"); 
    return;
  }
  if(games.length===0){ 
    alert("Bitte mindestens ein Spiel hinzuf√ºgen"); 
    return;
  }

  const tName = document.getElementById("tName").value;
  const tDate = document.getElementById("tDate").value;

  // Turnier-Daten bauen
  const finalData = {
    name: tName,
    date: tDate,
    players: {}, // f√ºr √úbersicht
    games: [...games] // Array aller Spiele speichern
  };

  // Spieler-√úbersicht f√ºr Rangliste berechnen
  players.forEach(p=>{
    finalData.players[p] = {
      s: 0, n: 0, gl: 0, vl: 0, avg: 0, dq: 0
    };
  });

  // Stats zusammenrechnen
  games.forEach(g=>{
    players.forEach(p=>{
      if(g[p]){
        finalData.players[p].s += g[p].s;
        finalData.players[p].n += g[p].n;
        finalData.players[p].gl += g[p].gl;
        finalData.players[p].vl += g[p].vl;
        finalData.players[p].avg += g[p].avg;
        finalData.players[p].dq += g[p].dq;
      }
    });
  });

 players.forEach(p => {
  // AVG bleibt wie bisher
  const gameCount = games.filter(g => g[p]).length || 1;
  finalData.players[p].avg = finalData.players[p].avg / gameCount;

  // DQ: nur Spiele ber√ºcksichtigen, die dq != null sind
  const dqValues = games
    .filter(g => g[p] && g[p].dq !== null)  // null = keine Chance auf Doppel
    .map(g => g[p].dq);                     // 0 wird normal eingerechnet

  finalData.players[p].dq = dqValues.length 
    ? dqValues.reduce((a,b)=>a+b,0) / dqValues.length 
    : 0;
});
  
  // In Firebase speichern
  if(editId){
    update(ref(db,"tournaments/"+editId), finalData);
    editId = null;
    saveBtn.textContent = "Turnier speichern";
    cancelBtn.style.display = "none";
  } else {
    push(ref(db,"tournaments"), finalData);
  }

  // Inputs zur√ºcksetzen
  games = [];
  gameList.innerHTML = "";
  document.getElementById("tName").value = "";
  document.getElementById("tDate").value = "";
  p1Label.textContent = "Spieler 1";
  p2Label.textContent = "Spieler 2";
  player1Select.value = "";
  player2Select.value = "";
}

// Cancel Edit
function cancelEdit(){
  editId=null;
  saveBtn.textContent="Turnier speichern";
  cancelBtn.style.display="none";
  document.getElementById("tName").value="";
  document.getElementById("tDate").value="";
  games=[];
  gameList.innerHTML="";
}

// Turnier l√∂schen
window.deleteTournament = function(id){
  if(!confirm("Turnier wirklich l√∂schen?")) return;
  remove(ref(db,"tournaments/"+id));
};

// Bearbeiten-Funktion ‚Äì NEU
window.editTournament = function(id){
  const tRef = ref(db,"tournaments/"+id);
  onValue(tRef, snap => {
    const t = snap.val();
    if(!t) return;

    // Name & Datum setzen
    document.getElementById("tName").value = t.name;
    document.getElementById("tDate").value = t.date;

    // games[] mit den gespeicherten Spielen bef√ºllen
    games = []; // leeren vorher
    Object.keys(t.players).forEach(p => {
      // Firebase speichert pro Spieler nur ein Objekt mit stats
      // Wir m√ºssen daraus einzelne Spiele bauen, falls mehrere vorhanden
      // Hier: wir nehmen einfach alle bisherigen Spiele, falls t.players[p].games existiert
      // F√ºr dein bisheriges Setup: wir bauen einfach ein "einzelnes Spiel pro Turnier", wie es beim alten Code war
    });

    // Falls dein Turnier mehrere Spiele enth√§lt:
    // Firebase m√ºsste games pro Turnier als Array gespeichert haben, dann:
    if(t.games){ 
      games = t.games; // Array direkt √ºbernehmen
    } else {
      // Falls noch kein games Array existiert (alte Turniere), ein Spiel aus den Spieler-Daten bauen:
      const gameData = {};
      Object.keys(t.players).forEach(player => {
        gameData[player] = {
          s: t.players[player].s || 0,
          n: t.players[player].n || 0,
          gl: t.players[player].gl || 0,
          vl: t.players[player].vl || 0,
          avg: t.players[player].avg || 0,
          dq: t.players[player].dq || 0
        };
      });
      games.push(gameData);
    }

    // Spiele in der Liste anzeigen
    renderGameList();

    // Edit-Zustand setzen
    editId = id;
    saveBtn.textContent = "Update";
    cancelBtn.style.display = "inline-block";
  }, {onlyOnce:true});
};

// Firebase Listener
onValue(ref(db,"tournaments"),snap=>{
  allTournaments = snap.val()||{};
  buildYearFilter();   // bef√ºllt Jahr- & Monatsfilter
  buildWeekFilter();   // bef√ºllt Wochenfilter
  buildDayFilter();    // setzt Tagesfilter (max = heute)
  renderAll();         // zeigt die Turniere
});

// Filter Funktionen
function buildYearFilter() {
  const years = new Set();
  Object.values(allTournaments).forEach(t => years.add(t.date.slice(0,4)));
  yearFilter.innerHTML = '<option value="all">Alle Jahre</option>';
  [...years].sort().forEach(y => {
    yearFilter.innerHTML += `<option value="${y}">${y}</option>`;
  });
  buildMonthFilter();
}

function buildMonthFilter() {
  const selectedYear = yearFilter.value;
  const months = new Set();
  Object.values(allTournaments).forEach(t => {
    if(selectedYear === "all" || t.date.startsWith(selectedYear)) months.add(t.date.slice(5,7));
  });
  monthFilter.innerHTML = '<option value="all">Alle Monate</option>';
  [...months].sort().forEach(m => {
    const monthName = new Date(0, parseInt(m)-1).toLocaleString('de-DE',{month:'long'});
    monthFilter.innerHTML += `<option value="${m}">${monthName}</option>`;
  });
}

function buildWeekFilter(){
  const weeks = new Set();
  Object.values(allTournaments).forEach(t => {
    const d = new Date(t.date);
    const oneJan = new Date(d.getFullYear(),0,1);
    const week = Math.ceil((((d - oneJan) / 86400000) + oneJan.getDay()+1)/7);
    weeks.add(week);
  });
  weekFilter.innerHTML = '<option value="all">Alle Wochen</option>';
  [...weeks].sort((a,b)=>a-b).forEach(w=>{
    weekFilter.innerHTML += `<option value="${w}">${w}</option>`;
  });
}

function buildDayFilter(){
  // Das Inputfeld <input type="date"> braucht keine Optionen
  // wir setzen nur den Maximalwert auf heute, optional
  const today = new Date().toISOString().split("T")[0];
  dayFilter.max = today;
}
  
// Rangliste & Charts (1:1 aus altem Code)
function renderAll(){
  const year = yearFilter.value;
  const month = monthFilter.value;
  const week = weekFilter.value;
  const day = dayFilter.value;

  const stats = {};
  const turnierLabels = [];
  players.forEach(p => stats[p] = {s:0,n:0,gl:0,vl:0,avg:[],dq:[],turniere:[]});

  tournamentList.innerHTML = "";

  Object.entries(allTournaments).forEach(([id,t]) => {
    if(!t.date) return; // Sicherheitscheck

    // Datum normalisieren auf YYYY-MM-DD
    const parts = t.date.split("-");
    const yearStr = parts[0].padStart(4,"0");
    const monthStr = parts[1].padStart(2,"0");
    const dayStr = parts[2].padStart(2,"0");
    const normDate = `${yearStr}-${monthStr}-${dayStr}`;

    // Filter anwenden
    if(year !== "all" && year !== yearStr) return;
    if(month !== "all" && month !== monthStr) return;

    const d = new Date(normDate);
    const oneJan = new Date(d.getFullYear(),0,1);
    const weekNumber = Math.ceil((((d - oneJan)/86400000 + oneJan.getDay()+1)/7));
    if(week !== "all" && parseInt(week) !== weekNumber) return;

    if(day && day !== normDate) return;

    // Turnier-Box erstellen
    const div = document.createElement("div");
    div.className = "tournament";
    div.innerHTML = `
      <div class="tournament-header" onclick="toggleTournament('${id}')">
        <strong>${t.name}</strong> (${normDate})
      </div>
      <div class="tournament-body" id="t-body-${id}" style="display:none;">
        <button onclick="editTournament('${id}')">Bearbeiten</button>
        <button onclick="deleteTournament('${id}')">L√∂schen</button>
      </div>
    `;
    tournamentList.appendChild(div);

    // Stats f√ºr Rangliste/Charts
    turnierLabels.push(t.name);
    players.forEach(p => {
      const d = t.players[p] || {s:0,n:0,gl:0,vl:0,avg:0,dq:0};
      stats[p].s += d.s;
      stats[p].n += d.n;
      stats[p].gl += d.gl;
      stats[p].vl += d.vl;
      stats[p].avg.push(d.avg);
      stats[p].dq.push(d.dq);
      stats[p].turniere.push(t.name);
    });
  });

  renderRanking(stats);
  renderCharts(stats, turnierLabels);
}

window.toggleTournament = function(id){
  const body = document.getElementById("t-body-" + id);
  if(!body) return;

  body.style.display = body.style.display === "none"
    ? "block"
    : "none";
};
window.toggleTournamentList = function(){
  const wrapper = document.getElementById("tournamentListWrapper");
  if(!wrapper) return;

  wrapper.style.display = wrapper.style.display === "none"
    ? "block"
    : "none";
};
  
function renderRanking(stats){
  // Gesamte 180er pro Spieler berechnen
  const total180s = {};
  players.forEach(p => total180s[p] = 0);
  Object.values(highScores).forEach(entry => {
    if(total180s[entry.player] !== undefined){
      total180s[entry.player] += entry.count;
    }
  });

// Rendern der Rangliste
rankingDiv.innerHTML="";
  const sortable = players.map(p=>({...stats[p],player:p,diff:stats[p].gl-stats[p].vl}));
  sortable.sort((a,b)=>b.s-a.s||b.gl-a.gl||a.diff-b.diff);

  const highestAVG = Math.max(...players.map(p => stats[p].avg.reduce((sum,v)=>sum+v,0)/Math.max(stats[p].avg.length,1)));
  const bestDQ = Math.max(...players.map(p => stats[p].dq.reduce((sum,v)=>sum+v,0)/Math.max(stats[p].dq.length,1)));
  const mostWins = Math.max(...players.map(p => stats[p].s));

  sortable.forEach((r,i)=>{
    const medal = i<3?["ü•á","ü•à","ü•â"][i]:"";
    const badges = [];
    const avgMean = r.avg.reduce((sum,v)=>sum+v,0)/Math.max(r.avg.length,1);
    const dqMean = r.dq.reduce((sum,v)=>sum+v,0)/Math.max(r.dq.length,1);
    if(avgMean === highestAVG) badges.push("üåü");
    if(dqMean === bestDQ) badges.push("‚ö°");
    if(r.s === mostWins) badges.push("üèÜ");

    rankingDiv.innerHTML += `
      <div class="rank-row ${i===0?'gold':i===1?'silver':i===2?'bronze':''}">
        <div class="rank-left">
          <span class="medal">${medal}</span> ${r.player} ${badges.join('')}
        </div>
        <div class="rank-right">
          <span>S:${r.s} N:${r.n} GL:${r.gl} VL:${r.vl} Diff:${r.diff}</span>
          <span class="hs-icon">üéØ ${total180s[r.player]}</span>
        </div>
      </div>`;
  });
}

// Charts
function renderCharts(stats, turnierLabels){
  const labels = turnierLabels.map((t,i)=>i+1);

  avgBarChart?.destroy();
  avgTrendChart?.destroy();
  dqBarChart?.destroy();
  dqTrendChart?.destroy();
  winsChart?.destroy();
  diffChart?.destroy();

  avgBarChart = new Chart(document.getElementById("avgBarChart"),{
    type:"bar",
    data:{
      labels,
      datasets: players.map((p,i)=>({
        label:p+" AVG",
        data: stats[p].avg,
        backgroundColor:["#f59e0b","#6b7280","#b87333"][i],
        borderRadius:5
      }))
    },
    options:{responsive:true,plugins:{legend:{position:'top'}},scales:{x:{title:{display:true,text:'Spiel'}}, y:{title:{display:true,text:'AVG'}}}}
  });

  avgTrendChart = new Chart(document.getElementById("avgTrendChart"),{
    type:"line",
    data:{
      labels,
      datasets: players.map((p,i)=>({
        label:p+" AVG",
        data: stats[p].avg,
        borderColor:["#f59e0b","#6b7280","#b87333"][i],
        backgroundColor:["#f59e0b","#6b7280","#b87333"][i],
        tension:0.3,
        fill:false,
        pointRadius:5
      }))
    },
    options:{responsive:true,plugins:{legend:{position:'top'}},scales:{x:{title:{display:true,text:'Spiel'}}, y:{title:{display:true,text:'AVG'}}}}
  });

  dqBarChart = new Chart(document.getElementById("dqBarChart"),{
    type:"bar",
    data:{
      labels,
      datasets: players.map((p,i)=>({
        label:p+" DQ %",
        data: stats[p].dq,
        backgroundColor:["#fde68a","#e5e7eb","#a97142"][i],
        borderRadius:5
      }))
    },
    options:{responsive:true,plugins:{legend:{position:'top'}},scales:{x:{title:{display:true,text:'Spiel'}}, y:{title:{display:true,text:'DQ %'}}}}
  });

  dqTrendChart = new Chart(document.getElementById("dqTrendChart"),{
    type:"line",
    data:{
      labels,
      datasets: players.map((p,i)=>({
        label:p+" DQ %",
        data: stats[p].dq,
        borderColor:["#fde68a","#e5e7eb","#a97142"][i],
        backgroundColor:["#fde68a","#e5e7eb","#a97142"][i],
        tension:0.3,
        fill:false,
        pointRadius:5
      }))
    },
    options:{responsive:true,plugins:{legend:{position:'top'}},scales:{x:{title:{display:true,text:'Spiel'}}, y:{title:{display:true,text:'DQ %'}}}}
  });

  winsChart = new Chart(document.getElementById("winsChart"),{
    type:"bar",
    data:{labels:players,datasets:[{label:"Siege",data:players.map(p=>stats[p].s),backgroundColor:["#fde68a","#e5e7eb","#a97142"],borderRadius:8}]},
    options:{responsive:true,plugins:{tooltip:{callbacks:{label:(ctx)=>`Siege: ${ctx.raw}`}},legend:{display:false}},scales:{y:{beginAtZero:true,title:{display:true,text:'Siege'}}}}
  });

  diffChart = new Chart(document.getElementById("diffChart"),{
    type:"bar",
    data:{labels:players,datasets:[{label:"Differenz (GL-VL)",data:players.map(p=>stats[p].gl-stats[p].vl),backgroundColor:["#fcd34d","#d1d5db","#b87333"],borderRadius:8}]},
    options:{responsive:true,plugins:{tooltip:{callbacks:{label:(ctx)=>`Diff: ${ctx.raw}`}},legend:{display:false}},scales:{y:{beginAtZero:true,title:{display:true,text:'Differenz'}}}}
  });
}

// ------------------------
// üéØ 180er ‚Äì Eigenst√§ndige Funktion, summiert pro Spieler
// ------------------------
const hsPlayerSelect = document.getElementById("hsPlayer");
const hsCountInput = document.getElementById("hsCount");
const addHSBtn = document.getElementById("addHSBtn");
const hsTableBody = document.querySelector("#hsTable tbody");
const hsWrapper = document.getElementById("hsWrapper");

// Spieler einmalig ins Dropdown einf√ºgen
players.forEach(p => {
  if(!Array.from(hsPlayerSelect.options).some(opt => opt.value===p)){
    hsPlayerSelect.innerHTML += `<option value="${p}">${p}</option>`;
  }
});

// Firebase-Pfad f√ºr 180er
const hsRef = ref(db, "highscores");

// Lokale Liste
let highScores = [];
let hsEditId = null;

// Listener
onValue(hsRef, snap => {
  highScores = snap.val() || [];
  renderHSList();
});

// Hinzuf√ºgen / Update
addHSBtn.addEventListener("click", () => {
  const player = hsPlayerSelect.value;
  const count = parseInt(hsCountInput.value);

  if(!player || !count || count < 1){
    alert("Bitte Spieler und Anzahl korrekt eingeben");
    return;
  }

  const entry = { player, count, timestamp: new Date().toISOString() };

  if(hsEditId){
    update(ref(db,"highscores/"+hsEditId), entry);
    hsEditId = null;
    addHSBtn.textContent="Hinzuf√ºgen";
  } else {
    push(hsRef, entry);
  }

  hsPlayerSelect.value="";
  hsCountInput.value="";
});

// Auf-/zuklappen Funktion
window.toggleHSList = function(){
  hsWrapper.style.display = hsWrapper.style.display === "none" ? "block" : "none";
};

// Rendern (summiert pro Spieler)
function renderHSList(){
  hsTableBody.innerHTML="";

  // Summieren pro Spieler
  const totals = {};
  players.forEach(p => totals[p]=0);

  Object.values(highScores).forEach(entry => {
    if(totals[entry.player]!==undefined){
      totals[entry.player] += entry.count;
    }
  });

  // Zeilen erzeugen
 // Sortieren nach Gesamtzahl der 180er, absteigend
const sortedPlayers = players.slice().sort((a,b) => totals[b] - totals[a]);

// Zeilen erzeugen
sortedPlayers.forEach(player => {

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${player}</td>
      <td>${totals[player]}</td>
      <td>
        <button onclick="editHSByPlayer('${player}')">Bearbeiten</button>
        <button onclick="deleteHSByPlayer('${player}')">L√∂schen</button>
      </td>
    `;
    hsTableBody.appendChild(tr);
  });
}

// Bearbeiten nach Spieler
window.editHSByPlayer = function(player){
  // Suche den neuesten Eintrag f√ºr diesen Spieler
  const entries = Object.entries(highScores).filter(([id, entry]) => entry.player===player);
  if(entries.length===0) return;

  const [id, entry] = entries[entries.length-1]; // letzter Eintrag
  hsPlayerSelect.value = entry.player;
  hsCountInput.value = entry.count;
  hsEditId = id;
  addHSBtn.textContent="Update";
}

// L√∂schen nach Spieler
window.deleteHSByPlayer = function(player){
  if(!confirm(`Alle 180er von ${player} l√∂schen?`)) return;

  Object.entries(highScores).forEach(([id, entry]) => {
    if(entry.player===player) remove(ref(db,"highscores/"+id));
  });

  hsEditId = null;
  hsPlayerSelect.value="";
  hsCountInput.value="";
  addHSBtn.textContent="Hinzuf√ºgen";
}

</script>
</body>
</html>

























