<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Darts Rangliste</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<div class="app">

<header>
  <h1>ğŸ¯ Darts Rangliste</h1>
  <p>Gesamt- & Jahreswertung</p>
</header>

<section class="card">
  <h2>Turnier erfassen</h2>
  <div class="form-row">
    <input id="tournamentName" placeholder="Turniername">
    <input type="date" id="tournamentDate">
  </div>
  <div id="players"></div>
  <button class="primary" onclick="addTournament()">Turnier speichern</button>
</section>

<section class="card">
  <h2>Auswertung</h2>
  <select id="yearFilter"></select>
</section>

<section class="card">
  <h2>Rangliste</h2>
  <div id="ranking"></div>
</section>

<section class="card">
  <h2>Statistiken</h2>
  <canvas id="avgChart"></canvas>
  <canvas id="dqChart"></canvas>
</section>

<section class="card">
  <h2>Turniere</h2>
  <div id="tournamentList"></div>
</section>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBpIYgzHZbrtjBAHrbVlsqwkuI6weoQD2o",
  authDomain: "darts-turniere-dacfc.firebaseapp.com",
  databaseURL: "https://darts-turniere-dacfc-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "darts-turniere-dacfc",
  storageBucket: "darts-turniere-dacfc.firebasestorage.app",
  messagingSenderId: "779378324704",
  appId: "1:779378324704:web:88aaf743660af6c138cc85"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const refT = ref(db,"tournaments");

const players=["Pembe","Marki","Schoba"];
const playersDiv=document.getElementById("players");
players.forEach(p=>{
  playersDiv.innerHTML+=`
  <div class="player-row">
    <strong>${p}</strong>
    <input placeholder="S" type="number" id="${p}-s">
    <input placeholder="N" type="number" id="${p}-n">
    <input placeholder="GL" type="number" id="${p}-gl">
    <input placeholder="VL" type="number" id="${p}-vl">
    <input placeholder="AVG" type="number" step="0.01" id="${p}-avg">
    <input placeholder="DQ %" type="number" step="0.1" id="${p}-dq">
  </div>`;
});

window.addTournament=()=>{
  if(!tournamentName.value||!tournamentDate.value)return;
  const entries=players.map(p=>({
    player:p,
    s:+document.getElementById(`${p}-s`).value,
    n:+document.getElementById(`${p}-n`).value,
    gl:+document.getElementById(`${p}-gl`).value,
    vl:+document.getElementById(`${p}-vl`).value,
    avg:+document.getElementById(`${p}-avg`).value,
    dq:+document.getElementById(`${p}-dq`).value
  }));
  push(refT,{name:tournamentName.value,date:tournamentDate.value,entries});
};

let avgChart,dqChart,allTournaments=[];

onValue(refT,snap=>{
  allTournaments=snap.val()?Object.entries(snap.val()).map(([id,v])=>({id,...v})):[];
  initYearFilter();
  updateView();
});

yearFilter.onchange=updateView;

function initYearFilter(){
  const years=[...new Set(allTournaments.map(t=>t.date.slice(0,4)))].sort();
  yearFilter.innerHTML=`<option value="all">Alle Jahre</option>`+
    years.map(y=>`<option value="${y}">${y}</option>`).join("");
}

function updateView(){
  const year=yearFilter.value;
  const filtered=year==="all"?allTournaments:
    allTournaments.filter(t=>t.date.startsWith(year));
  renderRanking(filtered);
  renderCharts(filtered);
  renderTournaments(filtered);
}

function renderRanking(ts){
  const stats={}; players.forEach(p=>stats[p]={s:0,n:0,gl:0,vl:0});
  ts.forEach(t=>t.entries.forEach(e=>{
    const s=stats[e.player];
    s.s+=e.s; s.n+=e.n; s.gl+=e.gl; s.vl+=e.vl;
  }));
  const r=Object.entries(stats)
    .map(([p,s])=>({...s,player:p,diff:s.gl-s.vl}))
    .sort((a,b)=>b.s-a.s||b.gl-a.gl||b.diff-a.diff);

  ranking.innerHTML=r.map((x,i)=>`
    <div class="rank-row ${i<3?'top':''}">
      ${["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][i]||i+1} ${x.player}
      S:${x.s} N:${x.n} GL:${x.gl} VL:${x.vl} Diff:${x.diff}
    </div>`).join("");
}

function renderCharts(ts){
  const labels=ts.map(t=>t.name);
  const avgData=players.map(p=>({label:p,data:ts.map(t=>t.entries.find(e=>e.player===p).avg),tension:0.3}));
  const dqData=players.map(p=>({label:p,data:ts.map(t=>t.entries.find(e=>e.player===p).dq),tension:0.3}));
  avgChart?.destroy(); dqChart?.destroy();
  avgChart=new Chart(avgChartCtx,{type:"line",data:{labels,datasets:avgData}});
  dqChart=new Chart(dqChartCtx,{type:"line",data:{labels,datasets:dqData}});
}

function renderTournaments(ts){
  tournamentList.innerHTML=ts.map(t=>`
    <div class="tournament">
      <strong>${t.name}</strong> (${t.date})
      <button onclick="remove(ref(db,'tournaments/${t.id}'))">âœ•</button>
    </div>`).join("");
}
</script>
</body>
</html>
