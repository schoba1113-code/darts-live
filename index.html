<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Darts Rangliste</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="app">
<header>
  <h1>üéØ Darts Rangliste</h1>
</header>

<section class="card">
  <h2>Turnier erfassen</h2>
  <div class="form-row">
    <input id="tName" placeholder="Turniername">
    <input id="tDate" type="date">
  </div>

  <div class="form-row">
    <select id="player1">
      <option value="">Spieler 1</option>
    </select>
    <select id="player2">
      <option value="">Spieler 2</option>
    </select>
    <button class="primary" id="addGameBtn">Spiel hinzuf√ºgen</button>
  </div>

  <div id="gameForm"></div>

  <ul id="gameList"></ul>

  <button class="primary" id="saveBtn">Turnier speichern</button>
  <button class="secondary" id="cancelBtn" style="display:none;">Abbrechen</button>
</section>

<section class="card">
  <h2>Zeitraum w√§hlen</h2>
  <select id="yearFilter"></select>
  <select id="monthFilter"></select>
  <button id="applyFilterBtn">Anwenden</button>
</section>

<section class="card">
  <h2>Gesamtrangliste</h2>
  <div id="ranking"></div>
</section>

<section class="card">
  <h2>Gespeicherte Turniere</h2>
  <div id="tournamentList"></div>
</section>

<section class="card">
  <h2>AVG Statistik (Balken)</h2>
  <canvas id="avgBarChart"></canvas>
</section>

<section class="card">
  <h2>AVG Trend</h2>
  <canvas id="avgTrendChart"></canvas>
</section>

<section class="card">
  <h2>DQ Statistik (Balken)</h2>
  <canvas id="dqBarChart"></canvas>
</section>

<section class="card">
  <h2>DQ Trend</h2>
  <canvas id="dqTrendChart"></canvas>
</section>

<section class="card">
  <h2>Siege</h2>
  <canvas id="winsChart"></canvas>
</section>

<section class="card">
  <h2>Differenz (GL-VL)</h2>
  <canvas id="diffChart"></canvas>
</section>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBpIYgzHZbrtjBAHrbVlsqwkuI6weoQD2o",
  authDomain: "darts-turniere-dacfc.firebaseapp.com",
  databaseURL: "https://darts-turniere-dacfc-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "darts-turniere-dacfc",
  storageBucket: "darts-turniere-dacfc.appspot.com",
  messagingSenderId: "779378324704",
  appId: "1:779378324704:web:88aaf743660af6c138cc85"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const players = ["Pembe","Marki","Schoba"];
const player1Select = document.getElementById("player1");
const player2Select = document.getElementById("player2");
const gameForm = document.getElementById("gameForm");
const gameList = document.getElementById("gameList");
const saveBtn = document.getElementById("saveBtn");
const cancelBtn = document.getElementById("cancelBtn");
const rankingDiv = document.getElementById("ranking");
const tournamentList = document.getElementById("tournamentList");
const yearFilter = document.getElementById("yearFilter");
const monthFilter = document.getElementById("monthFilter");
const applyFilterBtn = document.getElementById("applyFilterBtn");
const tName = document.getElementById("tName");
const tDate = document.getElementById("tDate");

let allTournaments = {};
let games = [];
let editId = null;
let avgBarChart, avgTrendChart, dqBarChart, dqTrendChart, winsChart, diffChart;

// Spieler in Dropdown einf√ºgen
players.forEach(p=>{
  player1Select.innerHTML += `<option value="${p}">${p}</option>`;
  player2Select.innerHTML += `<option value="${p}">${p}</option>`;
});

// Spiel hinzuf√ºgen Button
document.getElementById("addGameBtn").addEventListener("click", addGame);
saveBtn.addEventListener("click", saveTournament);
cancelBtn.addEventListener("click", cancelEdit);
applyFilterBtn.addEventListener("click", renderAll);

function addGame(){
  const p1 = player1Select.value;
  const p2 = player2Select.value;
  if(!p1 || !p2 || p1===p2){ alert("Bitte zwei verschiedene Spieler w√§hlen"); return;}

  const gameData = {player1:p1, player2:p2, s1:0, n1:0, gl1:0, vl1:0, avg1:0, dq1:0, s2:0, n2:0, gl2:0, vl2:0, avg2:0, dq2:0};
  games.push(gameData);
  renderGameList();
}

// Spiel-Liste rendern
function renderGameList(){
  gameList.innerHTML="";
  games.forEach((g,i)=>{
    gameList.innerHTML += `<li>
      ${g.player1} vs ${g.player2}
      <input type="number" placeholder="S" value="${g.s1}" onchange="updateGame(${i},'s1',this.value)">
      <input type="number" placeholder="N" value="${g.n1}" onchange="updateGame(${i},'n1',this.value)">
      <input type="number" placeholder="GL" value="${g.gl1}" onchange="updateGame(${i},'gl1',this.value)">
      <input type="number" placeholder="VL" value="${g.vl1}" onchange="updateGame(${i},'vl1',this.value)">
      <input type="number" placeholder="AVG" value="${g.avg1}" onchange="updateGame(${i},'avg1',this.value)">
      <input type="number" placeholder="DQ" value="${g.dq1}" onchange="updateGame(${i},'dq1',this.value)">
      -
      <input type="number" placeholder="S" value="${g.s2}" onchange="updateGame(${i},'s2',this.value)">
      <input type="number" placeholder="N" value="${g.n2}" onchange="updateGame(${i},'n2',this.value)">
      <input type="number" placeholder="GL" value="${g.gl2}" onchange="updateGame(${i},'gl2',this.value)">
      <input type="number" placeholder="VL" value="${g.vl2}" onchange="updateGame(${i},'vl2',this.value)">
      <input type="number" placeholder="AVG" value="${g.avg2}" onchange="updateGame(${i},'avg2',this.value)">
      <input type="number" placeholder="DQ" value="${g.dq2}" onchange="updateGame(${i},'dq2',this.value)">
      <button onclick="deleteGame(${i})">‚ùå</button>
    </li>`;
  });
}

window.updateGame = function(index, field, value){
  games[index][field] = Number(value);
};

window.deleteGame = function(index){
  games.splice(index,1);
  renderGameList();
};

function saveTournament(){
  if(!tName.value || !tDate.value){ alert("Name & Datum fehlen"); return;}
  const data = {name:tName.value, date:tDate.value, games:[...games], players:{}};

  players.forEach(p=>{
    const stats = {s:0,n:0,gl:0,vl:0,avg:[],dq:[]};
    data.games.forEach(g=>{
      if(g.player1===p){
        stats.s+=g.s1; stats.n+=g.n1; stats.gl+=g.gl1; stats.vl+=g.vl; stats.avg.push(g.avg1); stats.dq.push(g.dq1);
      } else if(g.player2===p){
        stats.s+=g.s2; stats.n+=g.n2; stats.gl+=g.gl2; stats.vl+=g.vl; stats.avg.push(g.avg2); stats.dq.push(g.dq2);
      }
    });
    data.players[p]={s:stats.s,n:stats.n,gl:stats.gl,vl:stats.vl,
      avg:stats.avg.length?stats.avg.reduce((a,b)=>a+b,0)/stats.avg.length:0,
      dq:stats.dq.length?stats.dq.reduce((a,b)=>a+b,0)/stats.dq.length:0};
  });

  if(editId){
    const existingRef = ref(db,"tournaments/"+editId);
    onValue(existingRef,snap=>{
      const existing = snap.val();
      data.games = [...existing.games,...data.games.filter((_,i)=>i>=existing.games.length)];
      update(existingRef,data);
    },{onlyOnce:true});
    editId=null;
    saveBtn.textContent="Turnier speichern";
    cancelBtn.style.display="none";
  } else {
    push(ref(db,"tournaments"),data);
  }

  games=[];
  renderGameList();
  tName.value=""; tDate.value="";
}

function cancelEdit(){
  editId=null;
  saveBtn.textContent="Turnier speichern";
  cancelBtn.style.display="none";
  games=[]; renderGameList();
}

// Turnier l√∂schen
window.deleteTournament = function(id){
  if(!confirm("Turnier wirklich l√∂schen?")) return;
  remove(ref(db,"tournaments/"+id));
};

// Bearbeiten
window.editTournament = function(id){
  const tRef = ref(db,"tournaments/"+id);
  onValue(tRef,snap=>{
    const t = snap.val();
    if(!t) return;

    tName.value = t.name;
    tDate.value = t.date;
    games = [...t.games];
    renderGameList();

    editId=id;
    saveBtn.textContent="Update";
    cancelBtn.style.display="inline-block";
  },{onlyOnce:true});
};

// Firebase Listener
onValue(ref(db,"tournaments"),snap=>{
  allTournaments = snap.val()||{};
  buildYearFilter();
  renderAll();
});

// Filter
function buildYearFilter(){
  const years=new Set();
  Object.values(allTournaments).forEach(t=>years.add(t.date.slice(0,4)));
  yearFilter.innerHTML='<option value="all">Alle Jahre</option>';
  [...years].sort().forEach(y=>yearFilter.innerHTML+=`<option value="${y}">${y}</option>`);
  buildMonthFilter();
}
function buildMonthFilter(){
  const sel=yearFilter.value;
  const months=new Set();
  Object.values(allTournaments).forEach(t=>{
    if(sel==="all"||t.date.startsWith(sel)) months.add(t.date.slice(5,7));
  });
  monthFilter.innerHTML='<option value="all">Alle Monate</option>';
  [...months].sort().forEach(m=>{
    const monthName = new Date(0,parseInt(m)-1).toLocaleString('de-DE',{month:'long'});
    monthFilter.innerHTML+=`<option value="${m}">${monthName}</option>`;
  });
}

// Turniere & Spiele rendern
function renderAll(){
  const year=yearFilter.value;
  const month=monthFilter.value;
  const stats={}; const labels=[];
  players.forEach(p=>stats[p]={s:0,n:0,gl:0,vl:0,avg:[],dq:[],turniere:[]});

  tournamentList.innerHTML="";
  Object.entries(allTournaments).forEach(([id,t])=>{
    if(year!=="all"&&!t.date.startsWith(year)) return;
    if(month!=="all"&&t.date.slice(5,7)!==month) return;

    const div=document.createElement("div");
    div.className="tournament";

    let gamesOverview="";
    t.games.forEach((g,i)=>{
      gamesOverview+=`<div style="font-size:0.9rem; margin-bottom:2px;">
        Spiel ${i+1}: ${g.player1} (S:${g.s1} N:${g.n1} GL:${g.gl1} VL:${g.vl1} AVG:${g.avg1} DQ:${g.dq1})
        vs ${g.player2} (S:${g.s2} N:${g.n2} GL:${g.gl2} VL:${g.vl2} AVG:${g.avg2} DQ:${g.dq2})
      </div>`;
    });

    div.innerHTML=`
      <strong>${t.name} (${t.date})</strong>
      <div>${gamesOverview}</div>
      <button onclick="editTournament('${id}')">Bearbeiten</button>
      <button onclick="deleteTournament('${id}')">L√∂schen</button>
    `;
    tournamentList.appendChild(div);

    labels.push(t.name);
    players.forEach(p=>{
      const d=t.players[p];
      stats[p].s+=d.s; stats[p].n+=d.n; stats[p].gl+=d.gl; stats[p].vl+=d.vl;
      stats[p].avg.push(d.avg); stats[p].dq.push(d.dq); stats[p].turniere.push(t.name);
    });
  });

  renderRanking(stats);
  renderCharts(stats,labels);
}

// Rangliste & Charts (wie bisher, unver√§ndert)
function renderRanking(stats){
  rankingDiv.innerHTML="";
  const sortable=players.map(p=>({...stats[p],player:p,diff:stats[p].gl-stats[p].vl}));
  sortable.sort((a,b)=>b.s-a.s||b.gl-a.gl||a.diff-b.diff);

  const highestAVG=Math.max(...players.map(p=>stats[p].avg.reduce((a,b)=>a+b,0)/Math.max(stats[p].avg.length,1)));
  const bestDQ=Math.max(...players.map(p=>stats[p].dq.reduce((a,b)=>a+b,0)/Math.max(stats[p].dq.length,1)));
  const mostWins=Math.max(...players.map(p=>stats[p].s));

  sortable.forEach((r,i)=>{
    const medal=i<3?["ü•á","ü•à","ü•â"][i]:"";
    const badges=[];
    const avgMean=r.avg.reduce((a,b)=>a+b,0)/Math.max(r.avg.length,1);
    const dqMean=r.dq.reduce((a,b)=>a+b,0)/Math.max(r.dq.length,1);
    if(avgMean===highestAVG) badges.push("üåü");
    if(dqMean===bestDQ) badges.push("‚ö°");
    if(r.s===mostWins) badges.push("üèÜ");

    rankingDiv.innerHTML+=`<div class="rank-row ${i===0?'gold':i===1?'silver':i===2?'bronze':''}">
      <span class="medal">${medal}</span> ${r.player} ${badges.join('')} | S:${r.s} N:${r.n} GL:${r.gl} VL:${r.vl} Diff:${r.diff}
    </div>`;
  });
}

function renderCharts(stats, labels){
  const chartLabels=labels.map((_,i)=>i+1);

  avgBarChart?.destroy(); avgTrendChart?.destroy(); dqBarChart?.destroy();
  dqTrendChart?.destroy(); winsChart?.destroy(); diffChart?.destroy();

  avgBarChart=new Chart(document.getElementById("avgBarChart"),{
    type:"bar",
    data:{labels:chartLabels,datasets:players.map((p,i)=>({label:p+" AVG",data:stats[p].avg,backgroundColor:["#f59e0b","#6b7280","#b87333"][i],borderRadius:5}))},
    options:{responsive:true,plugins:{legend:{position:'top'}},scales:{x:{title:{display:true,text:'Spiel'}},y:{title:{display:true,text:'AVG'}}}}
  });

  avgTrendChart=new Chart(document.getElementById("avgTrendChart"),{
    type:"line",
    data:{labels:chartLabels,datasets:players.map((p,i)=>({label:p+" AVG",data:stats[p].avg,borderColor:["#f59e0b","#6b7280","#b87333"][i],backgroundColor:["#f59e0b","#6b7280","#b87333"][i],tension:0.3,fill:false,pointRadius:5}))},
    options:{responsive:true,plugins:{legend:{position:'top'}},scales:{x:{title:{display:true,text:'Spiel'}},y:{title:{display:true,text:'AVG'}}}}
  });

  dqBarChart=new Chart(document.getElementById("dqBarChart"),{
    type:"bar",
    data:{labels:chartLabels,datasets:players.map((p,i)=>({label:p+" DQ %",data:stats[p].dq,backgroundColor:["#fde68a","#e5e7eb","#a97142"][i],borderRadius:5}))},
    options:{responsive:true,plugins:{legend:{position:'top'}},scales:{x:{title:{display:true,text:'Spiel'}},y:{title:{display:true,text:'DQ %'}}}}
  });

  dqTrendChart=new Chart(document.getElementById("dqTrendChart"),{
    type:"line",
    data:{labels:chartLabels,datasets:players.map((p,i)=>({label:p+" DQ %",data:stats[p].dq,borderColor:["#fde68a","#e5e7eb","#a97142"][i],backgroundColor:["#fde68a","#e5e7eb","#a97142"][i],tension:0.3,fill:false,pointRadius:5}))},
    options:{responsive:true,plugins:{legend:{position:'top'}},scales:{x:{title:{display:true,text:'Spiel'}},y:{title:{display:true,text:'DQ %'}}}}
  });

  winsChart=new Chart(document.getElementById("winsChart"),{
    type:"bar",
    data:{labels:players,datasets:[{label:"Siege",data:players.map(p=>stats[p].s),backgroundColor:["#fde68a","#e5e7eb","#a97142"],borderRadius:8}]},
    options:{responsive:true,plugins:{tooltip:{callbacks:{label:(ctx)=>`Siege: ${ctx.raw}`}},legend:{display:false}},scales:{y:{beginAtZero:true,title:{display:true,text:'Siege'}}}}
  });

  diffChart=new Chart(document.getElementById("diffChart"),{
    type:"bar",
    data:{labels:players,datasets:[{label:"Differenz (GL-VL)",data:players.map(p=>stats[p].gl-stats[p].vl),backgroundColor:["#fcd34d","#d1d5db","#b87333"],borderRadius:8}]},
    options:{responsive:true,plugins:{tooltip:{callbacks:{label:(ctx)=>`Diff: ${ctx.raw}`}},legend:{display:false}},scales:{y:{beginAtZero:true,title:{display:true,text:'Differenz'}}}}
  });
}
</script>
</body>
</html>
