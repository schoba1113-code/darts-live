<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Darts Rangliste Live</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
  <h1>Darts Rangliste Live</h1>

  <section class="input-section">
    <h2>Turnier erfassen</h2>
    <input id="tournamentName" placeholder="Turniername">
    <input type="date" id="tournamentDate">
    <div id="players"></div>
    <button onclick="addTournament()">Turnier speichern</button>
  </section>

  <section class="ranking-section">
    <h2>Gesamtrangliste</h2>
    <div id="ranking"></div>

    <div class="charts">
      <canvas id="winsChart"></canvas>
      <canvas id="diffChart"></canvas>
    </div>
  </section>

  <section class="tournament-archive">
    <h2>Gespeicherte Turniere</h2>
    <div id="tournamentList"></div>
  </section>
</div>

<!-- Firebase Module Import -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // Firebase Konfiguration
  const firebaseConfig = {
    apiKey: "AIzaSyBpIYgzHZbrtjBAHrbVlsqwkuI6weoQD2o",
    authDomain: "darts-turniere-dacfc.firebaseapp.com",
    databaseURL: "https://darts-turniere-dacfc-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "darts-turniere-dacfc",
    storageBucket: "darts-turniere-dacfc.firebasestorage.app",
    messagingSenderId: "779378324704",
    appId: "1:779378324704:web:88aaf743660af6c138cc85"
  };

  // Firebase initialisieren
  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const tournamentsRef = ref(database, 'tournaments');

  // Spieler
  const players = ["Pembe", "Marki", "Schoba"];
  const playerDiv = document.getElementById("players");
  const tournamentName = document.getElementById("tournamentName");
  const tournamentDate = document.getElementById("tournamentDate");
  const rankingDiv = document.getElementById("ranking");
  const tournamentListDiv = document.getElementById("tournamentList");
  const winsChartCtx = document.getElementById("winsChart").getContext("2d");
  const diffChartCtx = document.getElementById("diffChart").getContext("2d");

  let winsChart, diffChart;

  // Spieler-Inputs erstellen
  players.forEach(p => {
    playerDiv.innerHTML += `
      <div class="card player-card">
        <strong>${p}</strong>
        <div>
          S: <input type="number" id="${p}-s" min="0" value="0">
          N: <input type="number" id="${p}-n" min="0" value="0">
          GL: <input type="number" id="${p}-gl" min="0" value="0">
          VL: <input type="number" id="${p}-vl" min="0" value="0">
        </div>
      </div>
    `;
  });

  // Neues Turnier speichern
  window.addTournament = function() {
    const name = tournamentName.value;
    const date = tournamentDate.value;
    if (!name || !date) { alert("Bitte Turniername und Datum ausfÃ¼llen!"); return; }

    const entries = players.map(p => ({
      player: p,
      wins: +document.getElementById(`${p}-s`).value,
      losses: +document.getElementById(`${p}-n`).value,
      gl: +document.getElementById(`${p}-gl`).value,
      vl: +document.getElementById(`${p}-vl`).value
    }));

    push(tournamentsRef, { name, date, entries });

    // Felder zurÃ¼cksetzen
    tournamentName.value = "";
    tournamentDate.value = "";
    players.forEach(p => {
      document.getElementById(`${p}-s`).value = 0;
      document.getElementById(`${p}-n`).value = 0;
      document.getElementById(`${p}-gl`).value = 0;
      document.getElementById(`${p}-vl`).value = 0;
    });
  }

  // Daten aus Firebase abrufen & live aktualisieren
  onValue(tournamentsRef, snapshot => {
    const data = snapshot.val();
    const tournaments = data ? Object.entries(data).map(([key, value]) => ({ key, ...value })) : [];
    buildRanking(tournaments);
  });

  function buildRanking(tournaments) {
    const stats = {};
    players.forEach(p => stats[p] = { wins: 0, losses: 0, gl: 0, vl: 0 });

    tournaments.forEach(t =>
      t.entries.forEach(e => {
        stats[e.player].wins += e.wins;
        stats[e.player].losses += e.losses;
        stats[e.player].gl += e.gl;
        stats[e.player].vl += e.vl;
      })
    );

    const ranking = Object.entries(stats)
      .map(([player, s]) => ({ player, ...s, diff: s.gl - s.vl }))
      .sort((a,b) => b.wins - a.wins || b.gl - a.gl || b.diff - a.diff);

    renderRanking(ranking);
    renderCharts(ranking);
    renderTournaments(tournaments);
  }

  function renderRanking(ranking) {
    rankingDiv.innerHTML = ranking.map((r,i) => `
      <div class="card player-card">
        <span>${["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"][i] || i+1}. ${r.player}</span>
        <span>S:${r.wins} N:${r.losses} GL:${r.gl} VL:${r.vl} Diff:${r.diff}</span>
      </div>
    `).join("");
  }

  function renderCharts(ranking) {
    const labels = ranking.map(r => r.player);

    if (winsChart) winsChart.destroy();
    if (diffChart) diffChart.destroy();

    winsChart = new Chart(winsChartCtx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: "Siege",
          data: ranking.map(r => r.wins),
          backgroundColor: ranking.map((r,i) => ["#FFD700","#C0C0C0","#CD7F32"][i] || "#4caf50"),
          borderRadius: 10
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });

    diffChart = new Chart(diffChartCtx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: "Diff",
          data: ranking.map(r => r.diff),
          backgroundColor: "#FF9800",
          borderRadius: 10
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } } }
    });
  }

  function renderTournaments(tournaments) {
    if (!tournaments.length) {
      tournamentListDiv.innerHTML = "<p>Keine Turniere gespeichert.</p>";
      return;
    }

    tournamentListDiv.innerHTML = tournaments.map(t => {
      const entriesHtml = t.entries.map(e => {
        const diff = e.gl - e.vl;
        return `<div>${e.player}: S:${e.wins} N:${e.losses} GL:${e.gl} VL:${e.vl} Diff:${diff}</div>`;
      }).join("");

      return `
        <div class="card">
          <strong>${t.name}</strong> (${t.date})
          <button class="delete-btn" onclick="deleteTournament('${t.key}')">LÃ¶schen</button>
          <div>${entriesHtml}</div>
        </div>
      `;
    }).join("");
  }

  window.deleteTournament = function(key) {
    if (confirm("Willst du dieses Turnier wirklich lÃ¶schen?")) {
      remove(ref(database, 'tournaments/' + key));
    }
  }
</script>

</body>
</html>
