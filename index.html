<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Darts Rangliste Live</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<div class="app">

<header>
  <h1>ğŸ¯ Darts Rangliste</h1>
  <p>Live â€¢ Alle Turniere â€¢ Gesamtwertung</p>
</header>

<section class="card">
  <h2>Turnier erfassen</h2>

  <div class="form-row">
    <input id="tournamentName" placeholder="Turniername">
    <input type="date" id="tournamentDate">
  </div>

  <div id="players"></div>

  <button class="primary" onclick="addTournament()">Turnier speichern</button>
</section>

<section class="card">
  <h2>Gesamtrangliste</h2>
  <div id="ranking"></div>
</section>

<section class="card">
  <h2>Statistiken</h2>
  <canvas id="avgChart"></canvas>
  <canvas id="dqChart"></canvas>
</section>

<section class="card">
  <h2>Gespeicherte Turniere</h2>
  <div id="tournamentList"></div>
</section>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBpIYgzHZbrtjBAHrbVlsqwkuI6weoQD2o",
  authDomain: "darts-turniere-dacfc.firebaseapp.com",
  databaseURL: "https://darts-turniere-dacfc-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "darts-turniere-dacfc",
  storageBucket: "darts-turniere-dacfc.firebasestorage.app",
  messagingSenderId: "779378324704",
  appId: "1:779378324704:web:88aaf743660af6c138cc85"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const refT = ref(db, "tournaments");

const players = ["Pembe", "Marki", "Schoba"];
const playersDiv = document.getElementById("players");

players.forEach(p=>{
  playersDiv.innerHTML += `
    <div class="player-row">
      <strong>${p}</strong>
      <input type="number" placeholder="S" id="${p}-s">
      <input type="number" placeholder="N" id="${p}-n">
      <input type="number" placeholder="GL" id="${p}-gl">
      <input type="number" placeholder="VL" id="${p}-vl">
      <input type="number" step="0.01" placeholder="AVG" id="${p}-avg">
      <input type="number" step="0.1" placeholder="DQ %" id="${p}-dq">
    </div>`;
});

window.addTournament = ()=>{
  if(!tournamentName.value || !tournamentDate.value){
    alert("Turniername und Datum fehlen");
    return;
  }

  const entries = players.map(p=>({
    player:p,
    s:+document.getElementById(`${p}-s`).value,
    n:+document.getElementById(`${p}-n`).value,
    gl:+document.getElementById(`${p}-gl`).value,
    vl:+document.getElementById(`${p}-vl`).value,
    avg:+document.getElementById(`${p}-avg`).value,
    dq:+document.getElementById(`${p}-dq`).value
  }));

  push(refT,{
    name:tournamentName.value,
    date:tournamentDate.value,
    entries
  });
};

let avgChart, dqChart;

onValue(refT,snap=>{
  const data=snap.val();
  if(!data) return;

  const tournaments=Object.entries(data).map(([id,v])=>({id,...v}));
  renderRanking(tournaments);
  renderCharts(tournaments);
  renderTournaments(tournaments);
});

function renderRanking(tournaments){
  const stats={};
  players.forEach(p=>stats[p]={s:0,n:0,gl:0,vl:0});

  tournaments.forEach(t=>t.entries.forEach(e=>{
    const s=stats[e.player];
    s.s+=e.s; s.n+=e.n; s.gl+=e.gl; s.vl+=e.vl;
  }));

  const sorted=Object.entries(stats)
    .map(([p,s])=>({...s,player:p,diff:s.gl-s.vl}))
    .sort((a,b)=>b.s-a.s||b.gl-a.gl||b.diff-a.diff);

  ranking.innerHTML=sorted.map((r,i)=>`
    <div class="rank-row ${i<3?'top':''}">
      <span>${["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][i]||i+1}</span>
      <strong>${r.player}</strong>
      <span>S:${r.s}</span>
      <span>N:${r.n}</span>
      <span>GL:${r.gl}</span>
      <span>VL:${r.vl}</span>
      <span>Diff:${r.diff}</span>
    </div>`).join("");
}

function renderCharts(tournaments){
  const labels=tournaments.map(t=>t.name);

  const avgData=players.map(p=>({
    label:p,
    data:tournaments.map(t=>t.entries.find(e=>e.player===p).avg),
    tension:0.3
  }));

  const dqData=players.map(p=>({
    label:p,
    data:tournaments.map(t=>t.entries.find(e=>e.player===p).dq),
    tension:0.3
  }));

  avgChart?.destroy();
  dqChart?.destroy();

  avgChart=new Chart(avgChart,{
    type:"line",
    data:{labels,datasets:avgData}
  });

  dqChart=new Chart(dqChart,{
    type:"line",
    data:{labels,datasets:dqData}
  });
}

function renderTournaments(tournaments){
  tournamentList.innerHTML=tournaments.map(t=>`
    <div class="tournament">
      <div class="t-head">
        <strong>${t.name}</strong>
        <small>${t.date}</small>
        <button onclick="remove(ref(db,'tournaments/${t.id}'))">âœ•</button>
      </div>
      ${t.entries.map(e=>`
        <div class="t-row">
          ${e.player} | S:${e.s} N:${e.n} GL:${e.gl} VL:${e.vl}
          AVG:${e.avg} DQ:${e.dq}%
        </div>`).join("")}
    </div>`).join("");
}
</script>
</body>
</html>
