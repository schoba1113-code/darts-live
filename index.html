<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Darts Rangliste</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="app">
<header>
  <h1>ðŸŽ¯ Darts Rangliste</h1>
</header>

<section class="card">
  <h2>Turnier erfassen</h2>
  <div class="form-row">
    <input id="tName" placeholder="Turniername">
    <input id="tDate" type="date">
  </div>

  <div id="gameForm">
    <h3>Spiel hinzufÃ¼gen</h3>
    <div class="form-row">
      <select id="player1">
        <option value="">Spieler 1</option>
      </select>
      <select id="player2">
        <option value="">Spieler 2</option>
      </select>
    </div>
    <div class="player-row" id="gameStats">
      <strong>Spieler 1</strong>
      <input placeholder="S" id="p1-s">
      <input placeholder="N" id="p1-n">
      <input placeholder="GL" id="p1-gl">
      <input placeholder="VL" id="p1-vl">
      <input placeholder="AVG" id="p1-avg">
      <input placeholder="DQ %" id="p1-dq">
    </div>
    <div class="player-row" id="gameStats2">
      <strong>Spieler 2</strong>
      <input placeholder="S" id="p2-s">
      <input placeholder="N" id="p2-n">
      <input placeholder="GL" id="p2-gl">
      <input placeholder="VL" id="p2-vl">
      <input placeholder="AVG" id="p2-avg">
      <input placeholder="DQ %" id="p2-dq">
    </div>
    <button class="primary" id="addGameBtn">Spiel hinzufÃ¼gen</button>
    <ul id="gameList"></ul>
  </div>

  <button class="primary" id="saveBtn">Turnier speichern</button>
  <button class="secondary" id="cancelBtn" style="display:none;">Abbrechen</button>
</section>

<section class="card">
  <h2>Zeitraum wÃ¤hlen</h2>
  <select id="yearFilter"></select>
  <select id="monthFilter"></select>
  <button id="applyFilterBtn">Anwenden</button>
</section>

<section class="card">
  <h2>Gesamtrangliste</h2>
  <div id="ranking"></div>
</section>

<section class="card">
  <h2>Gespeicherte Turniere</h2>
  <div id="tournamentList"></div>
</section>

<section class="card">
  <h2>AVG Statistik (Balken)</h2>
  <canvas id="avgBarChart"></canvas>
</section>

<section class="card">
  <h2>AVG Trend</h2>
  <canvas id="avgTrendChart"></canvas>
</section>

<section class="card">
  <h2>DQ Statistik (Balken)</h2>
  <canvas id="dqBarChart"></canvas>
</section>

<section class="card">
  <h2>DQ Trend</h2>
  <canvas id="dqTrendChart"></canvas>
</section>

<section class="card">
  <h2>Siege</h2>
  <canvas id="winsChart"></canvas>
</section>

<section class="card">
  <h2>Differenz (GL-VL)</h2>
  <canvas id="diffChart"></canvas>
</section>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBpIYgzHZbrtjBAHrbVlsqwkuI6weoQD2o",
  authDomain: "darts-turniere-dacfc.firebaseapp.com",
  databaseURL: "https://darts-turniere-dacfc-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "darts-turniere-dacfc",
  storageBucket: "darts-turniere-dacfc.appspot.com",
  messagingSenderId: "779378324704",
  appId: "1:779378324704:web:88aaf743660af6c138cc85"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const players = ["Pembe","Marki","Schoba"];
const player1Select = document.getElementById("player1");
const player2Select = document.getElementById("player2");
const gameList = document.getElementById("gameList");
const saveBtn = document.getElementById("saveBtn");
const cancelBtn = document.getElementById("cancelBtn");
const applyFilterBtn = document.getElementById("applyFilterBtn");
const rankingDiv = document.getElementById("ranking");
const tournamentList = document.getElementById("tournamentList");
const yearFilter = document.getElementById("yearFilter");
const monthFilter = document.getElementById("monthFilter");

let allTournaments = {};
let games = []; // alle Spiele innerhalb eines Turniers
let editId = null;

// Spieler fÃ¼r Dropdown
players.forEach(p=>{
  player1Select.innerHTML += `<option value="${p}">${p}</option>`;
  player2Select.innerHTML += `<option value="${p}">${p}</option>`;
});

document.getElementById("addGameBtn").addEventListener("click", addGame);
saveBtn.addEventListener("click", saveTournament);
cancelBtn.addEventListener("click", cancelEdit);
applyFilterBtn.addEventListener("click", renderAll);

// Spiel hinzufÃ¼gen
function addGame(){
  const p1 = player1Select.value;
  const p2 = player2Select.value;
  if(!p1 || !p2 || p1===p2){ alert("Bitte zwei verschiedene Spieler wÃ¤hlen"); return; }

  const gameData = {
    [p1]:{
      s:+document.getElementById("p1-s").value||0,
      n:+document.getElementById("p1-n").value||0,
      gl:+document.getElementById("p1-gl").value||0,
      vl:+document.getElementById("p1-vl").value||0,
      avg:+document.getElementById("p1-avg").value||0,
      dq:+document.getElementById("p1-dq").value||0
    },
    [p2]:{
      s:+document.getElementById("p2-s").value||0,
      n:+document.getElementById("p2-n").value||0,
      gl:+document.getElementById("p2-gl").value||0,
      vl:+document.getElementById("p2-vl").value||0,
      avg:+document.getElementById("p2-avg").value||0,
      dq:+document.getElementById("p2-dq").value||0
    }
  };

  games.push(gameData);

  // Liste aktualisieren
  const li = document.createElement("li");
  li.textContent = `${p1} vs ${p2} hinzugefÃ¼gt`;
  gameList.appendChild(li);

  // Inputs zurÃ¼cksetzen
  document.getElementById("p1-s").value="";
  document.getElementById("p1-n").value="";
  document.getElementById("p1-gl").value="";
  document.getElementById("p1-vl").value="";
  document.getElementById("p1-avg").value="";
  document.getElementById("p1-dq").value="";

  document.getElementById("p2-s").value="";
  document.getElementById("p2-n").value="";
  document.getElementById("p2-gl").value="";
  document.getElementById("p2-vl").value="";
  document.getElementById("p2-avg").value="";
  document.getElementById("p2-dq").value="";
}

// Turnier speichern
function saveTournament(){
  if(!document.getElementById("tName").value || !document.getElementById("tDate").value){ alert("Name & Datum fehlen"); return;}
  if(games.length===0){ alert("Bitte mindestens ein Spiel hinzufÃ¼gen"); return;}

  // Stats zusammenrechnen
  const stats = {};
  players.forEach(p=>stats[p]={s:0,n:0,gl:0,vl:0,avg:[],dq:[]});

  games.forEach(g=>{
    players.forEach(p=>{
      if(g[p]){
        stats[p].s += g[p].s;
        stats[p].n += g[p].n;
        stats[p].gl += g[p].gl;
        stats[p].vl += g[p].vl;
        stats[p].avg.push(g[p].avg);
        stats[p].dq.push(g[p].dq);
      }
    });
  });

  const finalData = {name: document.getElementById("tName").value,
                     date: document.getElementById("tDate").value,
                     players:{}};

  players.forEach(p=>{
    finalData.players[p] = {
      s: stats[p].s,
      n: stats[p].n,
      gl: stats[p].gl,
      vl: stats[p].vl,
      avg: stats[p].avg.reduce((a,b)=>a+b,0)/stats[p].avg.length,
      dq: stats[p].dq.reduce((a,b)=>a+b,0)/stats[p].dq.length
    };
  });

  if(editId){
    update(ref(db,"tournaments/"+editId),finalData);
    editId=null;
    saveBtn.textContent="Turnier speichern";
    cancelBtn.style.display="none";
  } else {
    push(ref(db,"tournaments"),finalData);
  }

  // Reset
  games=[];
  gameList.innerHTML="";
  document.getElementById("tName").value="";
  document.getElementById("tDate").value="";
}

// Cancel Edit
function cancelEdit(){
  editId=null;
  saveBtn.textContent="Turnier speichern";
  cancelBtn.style.display="none";
  document.getElementById("tName").value="";
  document.getElementById("tDate").value="";
  games=[];
  gameList.innerHTML="";
}

// Firebase Listener
onValue(ref(db,"tournaments"),snap=>{
  allTournaments = snap.val()||{};
  buildYearFilter();
  renderAll();
});

// Filter Funktionen
function buildYearFilter() {
  const years = new Set();
  Object.values(allTournaments).forEach(t => years.add(t.date.slice(0,4)));
  yearFilter.innerHTML = '<option value="all">Alle Jahre</option>';
  [...years].sort().forEach(y => {
    yearFilter.innerHTML += `<option value="${y}">${y}</option>`;
  });
  buildMonthFilter();
}

function buildMonthFilter() {
  const selectedYear = yearFilter.value;
  const months = new Set();
  Object.values(allTournaments).forEach(t => {
    if(selectedYear === "all" || t.date.startsWith(selectedYear)) months.add(t.date.slice(5,7));
  });
  monthFilter.innerHTML = '<option value="all">Alle Monate</option>';
  [...months].sort().forEach(m => {
    const monthName = new Date(0, parseInt(m)-1).toLocaleString('de-DE',{month:'long'});
    monthFilter.innerHTML += `<option value="${m}">${monthName}</option>`;
  });
}

// Hier kannst du renderAll, renderRanking, renderCharts 1:1 vom alten Code Ã¼bernehmen, da sich nichts daran Ã¤ndert
</script>
</body>
</html>
