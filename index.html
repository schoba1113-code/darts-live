<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Darts Rangliste</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="app">
<header>
  <h1>ðŸŽ¯ Darts Rangliste</h1>
</header>

<section class="card">
  <h2>Turnier erfassen</h2>
  <div class="form-row">
    <input id="tName" placeholder="Turniername">
    <input id="tDate" type="date">
  </div>
  <div id="players"></div>
  <button class="primary" id="saveBtn">Turnier speichern</button>
  <button class="secondary" id="cancelBtn" style="display:none;">Abbrechen</button>
</section>

<section class="card">
  <h2>Jahreswertung</h2>
  <select id="yearFilter" onchange="renderAll()"></select>
</section>

<section class="card">
  <h2>Gesamtrangliste</h2>
  <div id="ranking"></div>
</section>

<section class="card">
  <h2>Gespeicherte Turniere</h2>
  <div id="tournamentList"></div>
</section>

<section class="card">
  <h2>Statistiken</h2>
  <canvas id="avgChart"></canvas>
  <canvas id="dqChart"></canvas>
  <canvas id="winsChart"></canvas>
  <canvas id="diffChart"></canvas>
</section>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBpIYgzHZbrtjBAHrbVlsqwkuI6weoQD2o",
  authDomain: "darts-turniere-dacfc.firebaseapp.com",
  databaseURL: "https://darts-turniere-dacfc-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "darts-turniere-dacfc",
  storageBucket: "darts-turniere-dacfc.firebasestorage.app",
  messagingSenderId: "779378324704",
  appId: "1:779378324704:web:88aaf743660af6c138cc85"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const players = ["Pembe","Marki","Schoba"];
const playerDiv = document.getElementById("players");
const rankingDiv = document.getElementById("ranking");
const tournamentList = document.getElementById("tournamentList");
const yearFilter = document.getElementById("yearFilter");
const saveBtn = document.getElementById("saveBtn");
const cancelBtn = document.getElementById("cancelBtn");

let allTournaments = {};
let avgChart, dqChart, winsChart, diffChart;
let editId = null;

// Spieler Inputs erzeugen
players.forEach(p=>{
  playerDiv.innerHTML += `
  <div class="player-row">
    <strong>${p}</strong>
    <input placeholder="S" id="${p}-s">
    <input placeholder="N" id="${p}-n">
    <input placeholder="GL" id="${p}-gl">
    <input placeholder="VL" id="${p}-vl">
    <input placeholder="AVG" id="${p}-avg">
    <input placeholder="DQ %" id="${p}-dq">
  </div>`;
});

// Save/Update Button
saveBtn.addEventListener("click", () => {
  if(!tName.value || !tDate.value){ alert("Name & Datum fehlen"); return;}
  const data = {name: tName.value, date: tDate.value, players:{}};
  players.forEach(p=>{
    data.players[p]={
      s:+document.getElementById(`${p}-s`).value||0,
      n:+document.getElementById(`${p}-n`).value||0,
      gl:+document.getElementById(`${p}-gl`).value||0,
      vl:+document.getElementById(`${p}-vl`).value||0,
      avg:+document.getElementById(`${p}-avg`).value||0,
      dq:+document.getElementById(`${p}-dq`).value||0
    };
  });

  if(editId){ // Update bestehendes Turnier
    update(ref(db,"tournaments/"+editId),data);
    editId = null;
    saveBtn.textContent = "Turnier speichern";
    cancelBtn.style.display = "none";
  } else { // Neues Turnier
    push(ref(db,"tournaments"),data);
  }

  document.querySelectorAll("input").forEach(i=>i.value="");
});

// Abbrechen Button
cancelBtn.addEventListener("click", () => {
  editId = null;
  saveBtn.textContent = "Turnier speichern";
  cancelBtn.style.display = "none";
  document.querySelectorAll("input").forEach(i=>i.value="");
});

// Turnier lÃ¶schen
window.deleteTournament = function(id){
  if(!confirm("Turnier wirklich lÃ¶schen?")) return;
  remove(ref(db,"tournaments/"+id));
};

// Bearbeiten-Funktion
window.editTournament = function(id){
  const tRef = ref(db,"tournaments/"+id);
  onValue(tRef, snap => {
    const t = snap.val();
    if(!t) return;

    tName.value = t.name;
    tDate.value = t.date;
    players.forEach(p=>{
      const d = t.players[p];
      document.getElementById(`${p}-s`).value = d.s;
      document.getElementById(`${p}-n`).value = d.n;
      document.getElementById(`${p}-gl`).value = d.gl;
      document.getElementById(`${p}-vl`).value = d.vl;
      document.getElementById(`${p}-avg`).value = d.avg;
      document.getElementById(`${p}-dq`).value = d.dq;
    });

    editId = id;
    saveBtn.textContent = "Update";
    cancelBtn.style.display = "inline-block";
  }, {onlyOnce:true});
};

// Live Listener
onValue(ref(db,"tournaments"),snap=>{
  allTournaments = snap.val()||{};
  buildYearFilter();
  renderAll();
});

// Jahresfilter bauen
function buildYearFilter(){
  const years = new Set();
  Object.values(allTournaments).forEach(t=>years.add(t.date.slice(0,4)));
  yearFilter.innerHTML='<option value="all">Alle</option>';
  [...years].sort().forEach(y=>{
    yearFilter.innerHTML += `<option value="${y}">${y}</option>`;
  });
}

// Alle Turniere rendern
function renderAll(){
  const year = yearFilter.value;
  const stats = {};
  const turnierLabels = [];
  players.forEach(p=>stats[p]={s:0,n:0,gl:0,vl:0,avg:[],dq:[],turniere:[]});

  tournamentList.innerHTML = "";
  Object.entries(allTournaments).forEach(([id,t])=>{
    if(year!=="all" && !t.date.startsWith(year)) return;

    const div = document.createElement("div");
    div.className = "tournament";
    div.innerHTML = `
      <span>${t.name} (${t.date})</span>
      <button onclick="editTournament('${id}')">Bearbeiten</button>
      <button onclick="deleteTournament('${id}')">LÃ¶schen</button>
    `;
    tournamentList.appendChild(div);

    turnierLabels.push(t.name);
    players.forEach(p=>{
      const d = t.players[p];
      stats[p].s += d.s;
      stats[p].n += d.n;
      stats[p].gl += d.gl;
      stats[p].vl += d.vl;
      stats[p].avg.push(d.avg);
      stats[p].dq.push(d.dq);
      stats[p].turniere.push(t.name);
    });
  });

  renderRanking(stats);
  renderCharts(stats, turnierLabels);
}

// Rangliste rendern
function renderRanking(stats){
  rankingDiv.innerHTML = "";
  const sortable = players.map(p=>({...stats[p],player:p,diff:stats[p].gl-stats[p].vl}));
  sortable.sort((a,b)=>b.s-a.s||b.gl-a.gl||a.diff-b.diff);
  sortable.forEach((r,i)=>{
    const medal = i<3?["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"][i]:"";
    rankingDiv.innerHTML += `
      <div class="rank-row ${i===0?'gold':i===1?'silver':i===2?'bronze':''}">
        <span class="medal">${medal}</span> ${r.player} | S:${r.s} N:${r.n} GL:${r.gl} VL:${r.vl} Diff:${r.diff}
      </div>`;
  });
}

// Charts rendern
function renderCharts(stats, turnierLabels){
  const labels = turnierLabels.map((t,i)=>i+1);

  avgChart?.destroy();
  dqChart?.destroy();
  winsChart?.destroy();
  diffChart?.destroy();

  // AVG Chart
  avgChart = new Chart(document.getElementById("avgChart"),{
    type:"line",
    data:{
      labels,
      datasets:players.map((p,i)=>({
        label:p+" AVG",
        data:stats[p].avg,
        tension:0.3,
        borderColor:["#f59e0b","#6b7280","#b87333"][i],
        borderWidth:3,
        pointBackgroundColor:["#f59e0b","#6b7280","#b87333"][i],
        pointRadius:5,
        fill:false
      }))
    },
    options:{
      responsive:true,
      plugins:{
        tooltip:{
          callbacks:{
            title: (items)=>items.map(it=>stats[players[it.datasetIndex]].turniere[it.dataIndex]).join(", ")
          }
        }
      },
      scales:{x:{title:{display:true,text:'Spiel'}},y:{title:{display:true,text:'AVG'}}}
    }
  });

  // Doppelquote Chart
  dqChart = new Chart(document.getElementById("dqChart"),{
    type:"line",
    data:{
      labels,
      datasets:players.map((p,i)=>({
        label:p+" DQ %",
        data:stats[p].dq,
        tension:0.3,
        borderColor:["#f59e0b","#6b7280","#b87333"][i],
        borderWidth:3,
        pointBackgroundColor:["#f59e0b","#6b7280","#b87333"][i],
        pointRadius:5,
        fill:false
      }))
    },
    options:{
      responsive:true,
      plugins:{
        tooltip:{
          callbacks:{
            title: (items)=>items.map(it=>stats[players[it.datasetIndex]].turniere[it.dataIndex]).join(", ")
          }
        }
      },
      scales:{x:{title:{display:true,text:'Spiel'}},y:{title:{display:true,text:'DQ %'}}}
    }
  });

  // Siege Chart
  winsChart = new Chart(document.getElementById("winsChart"),{
    type:"bar",
    data:{
      labels:players,
      datasets:[{
        label:"Siege",
        data:players.map(p=>stats[p].s),
        backgroundColor:["#fde68a","#e5e7eb","#a97142"],
        borderRadius:8
      }]
    },
    options:{
      responsive:true,
      plugins:{
        tooltip:{
          callbacks:{ label:(ctx)=>`Siege: ${ctx.raw}` }
        },
        legend:{display:false}
      },
      scales:{y:{beginAtZero:true,title:{display:true,text:'Siege'}}}
    }
  });

  // Differenz Chart
  diffChart = new Chart(document.getElementById("diffChart"),{
    type:"bar",
    data:{
      labels:players,
      datasets:[{
        label:"Differenz (GL-VL)",
        data:players.map(p=>stats[p].gl-stats[p].vl),
        backgroundColor:["#fcd34d","#d1d5db","#b87333"],
        borderRadius:8
      }]
    },
    options:{
      responsive:true,
      plugins:{
        tooltip:{
          callbacks:{ label:(ctx)=>`Diff: ${ctx.raw}` }
        },
        legend:{display:false}
      },
      scales:{y:{beginAtZero:true,title:{display:true,text:'Differenz'}}}
    }
  });
}
</script>
</body>
</html>
