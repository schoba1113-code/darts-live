<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Darts Rangliste Live</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<div class="container">
  <h1>ðŸŽ¯ Darts Rangliste Live</h1>

  <!-- Turnier Eingabe -->
  <section class="card">
    <h2>Turnier erfassen</h2>
    <input id="tournamentName" placeholder="Turniername">
    <input type="date" id="tournamentDate">

    <div id="players"></div>
    <button onclick="addTournament()">Turnier speichern</button>
  </section>

  <!-- Rangliste -->
  <section class="card">
    <h2>Gesamtrangliste</h2>
    <div id="ranking"></div>
  </section>

  <!-- Diagramme -->
  <section class="card">
    <h2>Diagramme</h2>
    <canvas id="winsChart"></canvas>
    <canvas id="avgChart"></canvas>
    <canvas id="dqChart"></canvas>
  </section>

  <!-- Turniere -->
  <section class="card">
    <h2>Gespeicherte Turniere</h2>
    <div id="tournamentList"></div>
  </section>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBpIYgzHZbrtjBAHrbVlsqwkuI6weoQD2o",
  authDomain: "darts-turniere-dacfc.firebaseapp.com",
  databaseURL: "https://darts-turniere-dacfc-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "darts-turniere-dacfc",
  storageBucket: "darts-turniere-dacfc.firebasestorage.app",
  messagingSenderId: "779378324704",
  appId: "1:779378324704:web:88aaf743660af6c138cc85"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const refT = ref(db, "tournaments");

const players = ["Pembe","Marki","Schoba"];
const playersDiv = document.getElementById("players");

players.forEach(p=>{
  playersDiv.innerHTML += `
  <div class="player-input">
    <strong>${p}</strong><br>
    S <input type="number" id="${p}-s" value="0">
    N <input type="number" id="${p}-n" value="0">
    GL <input type="number" id="${p}-gl" value="0">
    VL <input type="number" id="${p}-vl" value="0">
    AVG <input type="number" step="0.01" id="${p}-avg" value="0">
    DQ % <input type="number" step="0.1" id="${p}-dq" value="0">
  </div>`;
});

window.addTournament = ()=>{
  const name = tournamentName.value;
  const date = tournamentDate.value;
  if(!name || !date) return alert("Name & Datum fehlen");

  const entries = players.map(p=>({
    player:p,
    s:+document.getElementById(`${p}-s`).value,
    n:+document.getElementById(`${p}-n`).value,
    gl:+document.getElementById(`${p}-gl`).value,
    vl:+document.getElementById(`${p}-vl`).value,
    avg:+document.getElementById(`${p}-avg`).value,
    dq:+document.getElementById(`${p}-dq`).value
  }));

  push(refT,{name,date,entries});
};

let winsChart, avgChart, dqChart;

onValue(refT,snap=>{
  const data=snap.val();
  if(!data) return;

  const tournaments=Object.entries(data).map(([k,v])=>({id:k,...v}));
  build(tournaments);
});

function build(tournaments){
  const stats={};
  players.forEach(p=>stats[p]={s:0,n:0,gl:0,vl:0});

  tournaments.forEach(t=>t.entries.forEach(e=>{
    const s=stats[e.player];
    s.s+=e.s; s.n+=e.n; s.gl+=e.gl; s.vl+=e.vl;
  }));

  const ranking=Object.entries(stats)
    .map(([p,s])=>({...s,player:p,diff:s.gl-s.vl}))
    .sort((a,b)=>b.s-a.s||b.gl-a.gl||b.diff-a.diff);

  document.getElementById("ranking").innerHTML=
    ranking.map((r,i)=>`
      <div>
        ${["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"][i]||i+1}. ${r.player}
        | S:${r.s} N:${r.n} GL:${r.gl} VL:${r.vl} Diff:${r.diff}
      </div>`).join("");

  drawCharts(tournaments);
  drawTournaments(tournaments);
}

function drawCharts(tournaments){
  const labels=tournaments.map(t=>t.name);

  const datasetsAvg = players.map((p,i)=>({
    label:p,
    data:tournaments.map(t=>t.entries.find(e=>e.player===p).avg),
    borderWidth:2
  }));

  const datasetsDQ = players.map((p,i)=>({
    label:p,
    data:tournaments.map(t=>t.entries.find(e=>e.player===p).dq),
    borderWidth:2
  }));

  avgChart?.destroy();
  dqChart?.destroy();

  avgChart=new Chart(avgChartCtx,{
    type:"line",
    data:{labels,datasets:datasetsAvg}
  });

  dqChart=new Chart(dqChartCtx,{
    type:"line",
    data:{labels,datasets:datasetsDQ}
  });
}

function drawTournaments(tournaments){
  tournamentList.innerHTML=tournaments.map(t=>`
    <div>
      <strong>${t.name}</strong> (${t.date})
      <button onclick="remove(ref(db,'tournaments/${t.id}'))">LÃ¶schen</button>
      ${t.entries.map(e=>`
        <div>
          ${e.player} | S:${e.s} N:${e.n} GL:${e.gl} VL:${e.vl}
          AVG:${e.avg} DQ:${e.dq}%
        </div>`).join("")}
    </div>`).join("");
}
</script>
</body>
</html>
