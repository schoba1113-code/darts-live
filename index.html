<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Darts Rangliste</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="app">
<header><h1>ğŸ¯ Darts Rangliste</h1></header>

<section class="card">
<h2 id="formTitle">Turnier erfassen</h2>
<div class="form-row">
<input id="tName" placeholder="Turniername">
<input id="tDate" type="date">
</div>
<div id="players"></div>
<button class="primary" id="saveBtn">Turnier speichern</button>
</section>

<section class="card">
<h2>Gesamtrangliste</h2>
<div id="ranking"></div>
</section>

<section class="card">
<h2>Turniere</h2>
<div id="tournamentList"></div>
</section>

<section class="card">
<h2>Statistiken</h2>
<canvas id="avgChart"></canvas>
<canvas id="dqChart"></canvas>
<canvas id="winsChart"></canvas>
<canvas id="diffChart"></canvas>
</section>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBpIYgzHZbrtjBAHrbVlsqwkuI6weoQD2o",
  authDomain: "darts-turniere-dacfc.firebaseapp.com",
  databaseURL: "https://darts-turniere-dacfc-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "darts-turniere-dacfc",
  storageBucket: "darts-turniere-dacfc.firebasestorage.app",
  messagingSenderId: "779378324704",
  appId: "1:779378324704:web:88aaf743660af6c138cc85"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const players = ["Pembe","Marki","Schoba"];
const playerDiv = document.getElementById("players");
const rankingDiv = document.getElementById("ranking");
const tournamentList = document.getElementById("tournamentList");

let editId = null;
let allTournaments = {};
let avgChart, dqChart, winsChart, diffChart;

players.forEach(p=>{
  playerDiv.innerHTML += `
  <div class="player-row">
    <strong>${p}</strong>
    <input id="${p}-s" placeholder="S">
    <input id="${p}-n" placeholder="N">
    <input id="${p}-gl" placeholder="GL">
    <input id="${p}-vl" placeholder="VL">
    <input id="${p}-avg" placeholder="AVG">
    <input id="${p}-dq" placeholder="DQ %">
  </div>`;
});

saveBtn.onclick = () => {
  if(!tName.value || !tDate.value) return alert("Name & Datum fehlen");

  const data = {name:tName.value, date:tDate.value, players:{}};
  players.forEach(p=>{
    data.players[p]={
      s:+document.getElementById(`${p}-s`).value||0,
      n:+document.getElementById(`${p}-n`).value||0,
      gl:+document.getElementById(`${p}-gl`).value||0,
      vl:+document.getElementById(`${p}-vl`).value||0,
      avg:+document.getElementById(`${p}-avg`).value||0,
      dq:+document.getElementById(`${p}-dq`).value||0
    };
  });

  editId
    ? update(ref(db,"tournaments/"+editId),data)
    : push(ref(db,"tournaments"),data);

  editId=null;
  saveBtn.textContent="Turnier speichern";
  formTitle.textContent="Turnier erfassen";
  document.querySelectorAll("input").forEach(i=>i.value="");
};

onValue(ref(db,"tournaments"),snap=>{
  allTournaments = snap.val()||{};
  renderAll();
});

function renderAll(){
  const stats={};
  players.forEach(p=>stats[p]={s:0,n:0,gl:0,vl:0,avg:[],dq:[]});
  tournamentList.innerHTML="";

  Object.entries(allTournaments).forEach(([id,t])=>{
    tournamentList.innerHTML+=`
    <div class="tournament">
      <span>${t.name} (${t.date})</span>
      <div>
        <button onclick="edit('${id}')">âœï¸</button>
        <button onclick="del('${id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`;

    players.forEach(p=>{
      const d=t.players[p];
      stats[p].s+=d.s;
      stats[p].n+=d.n;
      stats[p].gl+=d.gl;
      stats[p].vl+=d.vl;
      stats[p].avg.push(d.avg);
      stats[p].dq.push(d.dq);
    });
  });

  renderRanking(stats);
  renderCharts(stats);
}

window.edit=id=>{
  editId=id;
  const t=allTournaments[id];
  tName.value=t.name; tDate.value=t.date;
  players.forEach(p=>{
    const d=t.players[p];
    ["s","n","gl","vl","avg","dq"].forEach(k=>{
      document.getElementById(`${p}-${k}`).value=d[k];
    });
  });
  saveBtn.textContent="Ã„nderungen speichern";
  formTitle.textContent="Turnier bearbeiten";
  window.scrollTo({top:0,behavior:"smooth"});
};

window.del=id=>{
  if(confirm("Turnier lÃ¶schen?")) remove(ref(db,"tournaments/"+id));
};

function renderRanking(stats){
  rankingDiv.innerHTML="";
  players
    .map(p=>({...stats[p],p,diff:stats[p].gl-stats[p].vl}))
    .sort((a,b)=>b.s-a.s||b.diff-a.diff)
    .forEach((r,i)=>{
      rankingDiv.innerHTML+=`
      <div class="rank-row ${["gold","silver","bronze"][i]||""}">
      ${["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][i]||""} ${r.p} | S:${r.s} N:${r.n} Diff:${r.diff}
      </div>`;
    });
}

function renderCharts(stats){
  avgChart?.destroy(); dqChart?.destroy(); winsChart?.destroy(); diffChart?.destroy();

  avgChart=new Chart(avgChartElem,{type:"line",
    data:{labels:stats.Pembe.avg.map((_,i)=>i+1),
    datasets:players.map((p,i)=>({label:p,data:stats[p].avg,borderColor:["#f59e0b","#6b7280","#b87333"][i]}))}
  });

  dqChart=new Chart(dqChartElem,{type:"line",
    data:{labels:stats.Pembe.dq.map((_,i)=>i+1),
    datasets:players.map((p,i)=>({label:p,data:stats[p].dq,borderColor:["#f59e0b","#6b7280","#b87333"][i]}))}
  });

  winsChart=new Chart(winsChartElem,{type:"bar",
    data:{labels:players,datasets:[{data:players.map(p=>stats[p].s),backgroundColor:["#fde68a","#e5e7eb","#a97142"]}]}
  });

  diffChart=new Chart(diffChartElem,{type:"bar",
    data:{labels:players,datasets:[{data:players.map(p=>stats[p].gl-stats[p].vl),backgroundColor:["#fcd34d","#d1d5db","#b87333"]}]}
  });
}
</script>
</body>
</html>
